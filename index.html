<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oregon Comprehensive Energy Assessment</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="src/data_loader.js"></script>
    <script src="src/incentive_rules.js"></script>
    <script src="src/incentive_calculator.js"></script>
    <script src="src/report_generator.js"></script>
    <style>
        :root {
            --brand: #2c5530;
            --brand-light: #5cb85c;
            --accent: #3282b8;
            --accent-dark: #0f4c75;
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #2e2e2e;
            --muted: #6b7280;
            --success: #28a745;
            --warning: #fd7e14;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 2rem;
            text-align: center;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }

        .app-header h1 {
            color: var(--brand);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .app-header .subtitle {
            color: var(--muted);
            font-size: 1.1rem;
        }

        /* Progress Steps */
        .progress-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e5e7eb;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 25px;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--brand), var(--brand-light));
            z-index: 1;
            transition: width 0.5s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
            flex: 1;
            cursor: pointer;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #9ca3af;
            transition: all 0.3s ease;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--muted);
            text-align: center;
            max-width: 120px;
        }

        .step.active .step-label {
            color: var(--brand);
        }

        /* Main Content Card */
        .main-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            min-height: 600px;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .module-title {
            color: var(--brand);
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--brand-light);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--brand);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e1ecf4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--brand-light);
            box-shadow: 0 0 0 4px rgba(92, 184, 92, 0.1);
            background: white;
        }

        .checkbox-group {
            display: grid;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background: #f3f4f6;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--brand-light);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 999px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            color: white;
            box-shadow: 0 10px 25px rgba(92, 184, 92, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(92, 184, 92, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* Results/Summary Styles */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .summary-card.highlight {
            border-color: var(--brand-light);
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--brand);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Eligibility badges */
        .badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0.25rem;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Recommendations Table */
        .recommendations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .recommendations-table th {
            background: var(--brand);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .recommendations-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .recommendations-table tr:last-child td {
            border-bottom: none;
        }

        .recommendations-table tr:hover {
            background: #f9fafb;
        }

        /* Customer ID Display */
        .customer-id-display {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .customer-id-display .id-label {
            font-size: 0.9rem;
            color: #1565c0;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .customer-id-display .id-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d47a1;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--brand-light);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Boxes */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 1.8rem;
            }
            
            .progress-steps {
                flex-wrap: wrap;
            }

            .step {
                flex-basis: 50%;
                margin-bottom: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .main-card {
                padding: 1.5rem;
            }
        }

        /* Concern Cards - Drag and Drop */
        .concerns-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .concern-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .concern-card:hover {
            border-color: var(--brand);
            box-shadow: 0 4px 12px rgba(44, 85, 48, 0.15);
            transform: translateY(-2px);
        }
        
        .concern-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .concern-card.drag-over {
            border-style: dashed;
            border-color: var(--brand);
            background: rgba(92, 184, 92, 0.1);
        }
        
        .concern-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .concern-text {
            flex: 1;
            font-weight: 500;
            color: var(--text);
        }
        
        .concern-handle {
            color: #d1d5db;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .priority-list .concern-card {
            background: white;
            border-color: white;
            position: relative;
        }
        
        .priority-list .concern-card::before {
            content: attr(data-rank);
            position: absolute;
            left: -2.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: var(--brand);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(44, 85, 48, 0.3);
        }
        
        .priority-list .empty-state {
            pointer-events: none;
        }
        
        .priority-list:not(:empty) .empty-state {
            display: none;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 2rem 0;
        }

        /* Info Panel */
        .info-panel {
            background: #f8f9fa;
            border-left: 4px solid var(--brand-light);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .info-panel h4 {
            color: var(--brand);
            margin-bottom: 0.5rem;
        }

        .info-panel p {
            color: var(--muted);
            line-height: 1.6;
        }

        /* Priority indicators */
        .priority-high {
            color: var(--danger);
            font-weight: bold;
        }

        .priority-medium {
            color: var(--warning);
            font-weight: bold;
        }

        .priority-low {
            color: var(--info);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <h1>üè† Oregon Comprehensive Energy Assessment</h1>
            <p class="subtitle">Complete energy efficiency evaluation with personalized incentive pathways</p>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                Independent tool ‚Ä¢ Not affiliated with or endorsed by Energy Trust, OHCS, or Oregon DOE ‚Ä¢ For official eligibility, contact program administrators directly
            </p>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line" id="progressLine"></div>
                <div class="step active" data-step="1" onclick="goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label">Customer Intake</div>
                </div>
                <div class="step" data-step="2" onclick="goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label">Income Qualification</div>
                </div>
                <div class="step" data-step="3" onclick="goToStep(3)">
                    <div class="step-circle">3</div>
                    <div class="step-label">Energy Assessment</div>
                </div>
                <div class="step" data-step="4" onclick="goToStep(4)">
                    <div class="step-circle">4</div>
                    <div class="step-label">Incentive Insights</div>
                </div>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="main-card">
            <!-- MODULE 1: Customer Intake -->
            <div class="module active" id="module1">
                <h2 class="module-title">Step 1: Customer Intake & Eligibility</h2>
                
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="loadDemoData()" style="float: right; padding: 0.5rem 1rem;">
                        üìã Load Demo Data
                    </button>
                    <h4 style="margin: 0 0 0.5rem 0;">Welcome to Your Energy Assessment</h4>
                    <p style="margin: 0;">Let's start by gathering some basic information to determine your eligibility for energy assistance programs and create your customer profile.</p>
                    <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: #666; font-style: italic;">
                        <strong>Note:</strong> This is an informational tool only. Program eligibility and incentive amounts must be confirmed directly with program administrators.
                    </p>
                    <div style="clear: both;"></div>
                </div>

                <form id="intakeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" class="form-control">
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Geographic & Program Information</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="county">Oregon County *</label>
                            <select id="county" class="form-control" required>
                                <option value="">Select your county...</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Utility Providers (Select all that apply) *</label>
                            <div style="background: #f9fafb; border: 2px solid #e1ecf4; border-radius: 10px; padding: 1rem; margin-top: 0.5rem;">
                                <div style="margin-bottom: 1rem;">
                                    <strong style="color: var(--brand); display: block; margin-bottom: 0.5rem;">‚ö° Electric Utilities</strong>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="pge">
                                            <span>Portland General Electric (PGE)</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="pacific_power">
                                            <span>Pacific Power</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="eweb">
                                            <span>Eugene Water & Electric Board (EWEB)</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="municipal">
                                            <span>Municipal Utility (City-owned)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--brand); display: block; margin-bottom: 0.5rem;">üî• Gas Utilities (Optional)</strong>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="nw_natural">
                                            <span>NW Natural Gas</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="cascade">
                                            <span>Cascade Natural Gas</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="avista">
                                            <span>Avista</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="propane">
                                            <span>Propane Only (No natural gas service)</span>
                                        </label>
                                    </div>
                                </div>
                                <small style="display: block; margin-top: 0.75rem; color: var(--muted);">‚úì Must select at least one electric utility</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="housingType">Housing Type *</label>
                            <select id="housingType" class="form-control" required>
                                <option value="">Select housing type...</option>
                                <option value="single_family">Single Family Home</option>
                                <option value="multi_family">Multi-Family</option>
                                <option value="townhome">Townhome</option>
                                <option value="manufactured">Manufactured Home</option>
                                <option value="condo">Condominium</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ownershipStatus">Home Ownership *</label>
                            <select id="ownershipStatus" class="form-control" required>
                                <option value="">Select status...</option>
                                <option value="own">Own</option>
                                <option value="rent">Rent</option>
                                <option value="landlord">Landlord (Own but don't live there)</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">üéØ Priority Community & Program Access</h3>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: var(--brand); margin-bottom: 0.5rem; display: block;">
                            Priority Community Self-Identification (Optional but helps determine eligibility)
                        </label>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Select all that apply. This information helps us identify enhanced incentive programs you may qualify for.
                        </p>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="low_income">
                                <span>Low-Income Household</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="tribal">
                                <span>Tribal Member or Living on Tribal Land</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="rural">
                                <span>Rural Community</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="community_of_color">
                                <span>Community of Color</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="other_underserved">
                                <span>Other Underserved Community</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="workingWithCBO">Are you working with a Community-Based Organization (CBO)?</label>
                        <select id="workingWithCBO" class="form-control" onchange="toggleCBODetails()">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="cboDetailsGroup" style="display: none; grid-column: 1 / -1;">
                        <label for="cboName">Community Organization Name</label>
                        <input type="text" id="cboName" class="form-control" placeholder="Enter organization name">
                        <small style="color: var(--muted); display: block; margin-top: 0.5rem;">
                            Working with a CBO may enable access to Community Partner Fund (CPF) and no-cost weatherization programs.
                        </small>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">üéØ Your Energy Priorities</h3>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; display: block;">
                            Rank Your Energy Concerns by Priority
                        </label>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Drag and drop the cards below to rank your concerns from highest (top) to lowest priority. Only include concerns that apply to your home.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                            <!-- Available Concerns Pool -->
                            <div>
                                <h4 style="color: var(--brand); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: var(--secondary); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem;">?</span>
                                    Available Concerns
                                </h4>
                                <div id="concernsPool" class="concerns-list" style="min-height: 300px; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem;">
                                    <div class="concern-card" draggable="true" data-id="high_bills" data-icon="üí∞">
                                        <span class="concern-icon">üí∞</span>
                                        <span class="concern-text">High energy bills</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="comfort" data-icon="üå°Ô∏è">
                                        <span class="concern-icon">üå°Ô∏è</span>
                                        <span class="concern-text">Home comfort (too hot/cold)</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="drafts" data-icon="üí®">
                                        <span class="concern-icon">üí®</span>
                                        <span class="concern-text">Drafts and air leaks</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="old_equipment" data-icon="üîß">
                                        <span class="concern-icon">üîß</span>
                                        <span class="concern-text">Old/inefficient heating/cooling</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="insulation" data-icon="üè†">
                                        <span class="concern-icon">üè†</span>
                                        <span class="concern-text">Poor insulation</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="windows" data-icon="ü™ü">
                                        <span class="concern-icon">ü™ü</span>
                                        <span class="concern-text">Old/inefficient windows</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="health" data-icon="‚ö†Ô∏è">
                                        <span class="concern-icon">‚ö†Ô∏è</span>
                                        <span class="concern-text">Health and safety concerns</span>
                                        <span class="concern-handle">‚ãÆ‚ãÆ</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Priority Ranking Area -->
                            <div>
                                <h4 style="color: var(--brand); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: var(--brand); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem;">‚Üí</span>
                                    Your Priority Ranking
                                </h4>
                                <div id="priorityRanking" class="concerns-list priority-list" style="min-height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid var(--brand); border-radius: 8px; padding: 1rem; position: relative;">
                                    <div class="empty-state" style="color: white; text-align: center; padding: 2rem 1rem; opacity: 0.8;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">üëÜ</div>
                                        <p style="margin: 0; font-size: 0.95rem;">Drag concerns here to rank them</p>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">#1 = Highest Priority</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="urgency">How urgent is your need for energy assistance?</label>
                        <select id="urgency" class="form-control">
                            <option value="immediate">Immediate - Critical need</option>
                            <option value="high">High - Need soon</option>
                            <option value="moderate">Moderate - Planning ahead</option>
                            <option value="low">Low - Exploring options</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="submitIntake()">
                            Continue to Income Qualification ‚Üí
                        </button>
                    </div>
                </form>
            </div>

            <!-- MODULE 2: Income Qualification -->
            <div class="module" id="module2">
                <h2 class="module-title">Step 2: Income Qualification</h2>
                
                <div class="customer-id-display" id="customerIdDisplay" style="display: none;">
                    <div class="id-label">Your Customer ID</div>
                    <div class="id-value" id="customerId"></div>
                </div>

                <div class="info-panel">
                    <h4>Income Eligibility Assessment</h4>
                    <p>This information helps us determine which energy assistance programs you qualify for. All information is confidential.</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                        Results are estimates only. Contact program administrators for official eligibility determination.
                    </p>
                </div>

                <form id="incomeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="householdSize">Household Size *</label>
                            <select id="householdSize" class="form-control" required>
                                <option value="1">1 person</option>
                                <option value="2">2 people</option>
                                <option value="3">3 people</option>
                                <option value="4">4 people</option>
                                <option value="5">5 people</option>
                                <option value="6">6 people</option>
                                <option value="7">7 people</option>
                                <option value="8">8 people</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="income">Household Income *</label>
                            <input type="number" id="income" class="form-control" min="0" step="100" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label for="frequency">Income Frequency *</label>
                            <select id="frequency" class="form-control" required>
                                <option value="annual">Annual</option>
                                <option value="monthly">Monthly</option>
                                <option value="biweekly">Biweekly</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Status *</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="taxStatus" value="pretax" checked>
                                    <span>Pre-tax (Gross)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="taxStatus" value="posttax">
                                    <span>Post-tax (Net)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="calculateIncome()">
                            Calculate Eligibility
                        </button>
                    </div>
                </form>

                <div id="incomeResults" style="display: none;">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Your Eligibility Results</h3>
                    
                    <div class="summary-grid" id="incomeSummary"></div>
                    
                    <div id="programEligibility"></div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                            Continue to Energy Assessment ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODULE 3: Energy Assessment -->
            <div class="module" id="module3">
                <h2 class="module-title">Step 3: Home Energy Assessment</h2>
                
                <div class="info-panel">
                    <h4>Comprehensive Home Energy Evaluation</h4>
                    <p>Provide details about your home's current condition and systems. Use "N/A" for unknown items.</p>
                </div>

                <form id="assessmentForm">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Property Details</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="homeSquareFootage">Home Square Footage</label>
                            <input type="number" id="homeSquareFootage" class="form-control" placeholder="e.g., 2000">
                        </div>
                        <div class="form-group">
                            <label for="conditionedSpace">Conditioned Space (for HVAC sizing)</label>
                            <input type="number" id="conditionedSpace" class="form-control" placeholder="e.g., 1800">
                        </div>
                        <div class="form-group">
                            <label for="foundationType">Foundation Type</label>
                            <select id="foundationType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="slab">Slab</option>
                                <option value="crawlspace">Crawlspace</option>
                                <option value="basement_unfinished">Basement - Unfinished</option>
                                <option value="basement_finished">Basement - Finished</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="roofCondition">Roof Condition</label>
                            <select id="roofCondition" class="form-control">
                                <option value="na">N/A</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Building Envelope</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="atticInsulation">Attic Insulation</label>
                            <select id="atticInsulation" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">None</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wallInsulation">Wall Insulation</label>
                            <select id="wallInsulation" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">None</option>
                                <option value="partial">Partial</option>
                                <option value="full">Full</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowType">Window Type</label>
                            <select id="windowType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="single">Single Pane</option>
                                <option value="double">Double Pane</option>
                                <option value="triple">Triple Pane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="doorSealing">Door Sealing</label>
                            <select id="doorSealing" class="form-control">
                                <option value="na">N/A</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">HVAC Systems</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="heatingType">Primary Heating System</label>
                            <select id="heatingType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="gas_furnace">Gas Furnace</option>
                                <option value="electric_furnace">Electric Furnace</option>
                                <option value="heat_pump">Heat Pump</option>
                                <option value="baseboard">Electric Baseboard</option>
                                <option value="wood_stove">Wood Stove</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="heatingAge">Heating System Age (years)</label>
                            <input type="number" id="heatingAge" class="form-control" min="0" placeholder="Years">
                        </div>
                        <div class="form-group">
                            <label for="coolingType">Cooling System</label>
                            <select id="coolingType" class="form-control">
                                <option value="none">None</option>
                                <option value="central_ac">Central AC</option>
                                <option value="heat_pump">Heat Pump</option>
                                <option value="window_units">Window Units</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ductwork">Ductwork Condition</label>
                            <select id="ductwork" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">No Ducts</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Health & Safety</h3>
                    
                    <div class="form-group">
                        <label>Check all that apply:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="combustion">
                                <span>Combustion Appliances Present</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="moisture">
                                <span>Moisture/Water Issues</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="mold">
                                <span>Visible Mold</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="asbestos">
                                <span>Suspected Asbestos</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="lead">
                                <span>Suspected Lead Paint</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="none">
                                <span>No Known Health/Safety Issues</span>
                            </label>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            ‚Üê Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="analyzeAssessment()">
                            Analyze Home Assessment
                        </button>
                    </div>
                </form>

                <div id="assessmentResults" style="display: none;">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Assessment Summary</h3>
                    
                    <div class="summary-grid" id="assessmentSummary"></div>
                    
                    <div id="assessmentRecommendations"></div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="editAssessment()">
                            ‚Üê Edit Assessment
                        </button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(4)">
                            View Personalized Incentives ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODULE 4: Incentive Insights & Pathways -->
            <div class="module" id="module4">
                <h2 class="module-title">Step 4: Personalized Incentive Pathways</h2>
                
                <div class="info-panel">
                    <h4>Your Customized Retrofit Plan</h4>
                    <p>Based on your intake profile, income eligibility, and home assessment, here are your personalized recommendations with available incentives and financing options.</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                        <strong>Disclaimer:</strong> This tool is not affiliated with Energy Trust of Oregon, Oregon Housing & Community Services, or Oregon Department of Energy. 
                        Incentive amounts and eligibility are estimates‚Äîapplications must be submitted through official program channels for verification and approval.
                    </p>
                </div>

                <div id="comprehensiveResults">
                    <div class="alert alert-info">
                        <strong>üìã Complete all previous steps to see your personalized incentive pathways.</strong>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">
                        ‚Üê Back to Assessment
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadReport()">
                        üì• Download Full Report
                    </button>
                    <button type="button" class="btn btn-primary" onclick="startOver()">
                        üîÑ Start New Assessment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer Disclaimer -->
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1.5rem; margin-top: 2rem; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);">
            <h3 style="color: var(--brand); font-size: 1.1rem; margin-bottom: 0.75rem;">üìÑ Important Disclaimer</h3>
            <p style="font-size: 0.9rem; color: #666; line-height: 1.6; margin: 0;">
                This Oregon Comprehensive Energy Assessment tool is an <strong>independent resource</strong> provided for informational and educational purposes only. 
                It is <strong>not affiliated with, endorsed by, or officially connected to</strong> Energy Trust of Oregon, Oregon Housing & Community Services (OHCS), 
                Oregon Department of Energy (ODOE), or any federal, state, or local energy assistance program.
            </p>
            <p style="font-size: 0.9rem; color: #666; line-height: 1.6; margin: 0.75rem 0 0 0;">
                <strong>All eligibility determinations, incentive amounts, and program access must be confirmed directly with official program administrators.</strong> 
                Estimates provided by this tool are based on 2025 program guidelines but are subject to change based on program availability, funding levels, and individual circumstances. 
                To apply for programs or verify eligibility, please contact the respective program administrators using the contact information provided in your assessment results.
            </p>
            <p style="font-size: 0.85rem; color: #888; margin: 0.75rem 0 0 0; font-style: italic;">
                Data sources: 2025 HUD Income Limits, Federal Poverty Guidelines, Energy Trust program guidelines, and publicly available program documentation. 
                Last updated: 2025. Use at your own discretion.
            </p>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        const appState = {
            currentStep: 1,
            customerData: {},
            incomeData: {},
            assessmentData: {},
            eligibilityResults: {},
            recommendations: []
        };

        // ===== OREGON DATA (2025 OFFICIAL) =====
        // Source: oregon-income-calculator repo (2025 HUD Income Limits)
        const oregonCounties = {
            "Baker County": { ami: 55800 },
            "Benton County": { ami: 76900 },
            "Clackamas County": { ami: 95800 },
            "Clatsop County": { ami: 67500 },
            "Columbia County": { ami: 82100 },
            "Coos County": { ami: 61400 },
            "Crook County": { ami: 61900 },
            "Curry County": { ami: 56200 },
            "Deschutes County": { ami: 81300 },
            "Douglas County": { ami: 63200 },
            "Gilliam County": { ami: 58400 },
            "Grant County": { ami: 52100 },
            "Harney County": { ami: 53900 },
            "Hood River County": { ami: 79400 },
            "Jackson County": { ami: 68900 },
            "Jefferson County": { ami: 59700 },
            "Josephine County": { ami: 58700 },
            "Klamath County": { ami: 58900 },
            "Lake County": { ami: 54700 },
            "Lane County": { ami: 72100 },
            "Lincoln County": { ami: 64700 },
            "Linn County": { ami: 69200 },
            "Malheur County": { ami: 51200 },
            "Marion County": { ami: 78400 },
            "Morrow County": { ami: 67800 },
            "Multnomah County": { ami: 95800 },
            "Polk County": { ami: 73800 },
            "Sherman County": { ami: 59100 },
            "Tillamook County": { ami: 67300 },
            "Umatilla County": { ami: 62800 },
            "Union County": { ami: 57600 },
            "Wallowa County": { ami: 54300 },
            "Wasco County": { ami: 65100 },
            "Washington County": { ami: 98200 },
            "Wheeler County": { ami: 50800 },
            "Yamhill County": { ami: 75600 }
        };

        // 2025 Federal Poverty Guidelines (HHS)
        const fplData = {
            1: 15060, 2: 20440, 3: 25820, 4: 31200,
            5: 36580, 6: 41960, 7: 47340, 8: 52720
        };

        // 2025 Household size adjustments for AMI/SMI
        const householdAdjustments = {
            1: 0.70, 2: 0.80, 3: 0.90, 4: 1.00,
            5: 1.08, 6: 1.16, 7: 1.24, 8: 1.32
        };

        // 2025 Oregon State Median Income
        const oregonSMI = 78600;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            populateCounties();
            initializeApp();
            initializeDragAndDrop();
        });

        function populateCounties() {
            const countySelect = document.getElementById('county');
            Object.keys(oregonCounties).sort().forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countySelect.appendChild(option);
            });
        }

        function initializeApp() {
            updateProgress();
        }

        // ===== NAVIGATION =====
        function goToStep(step) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(module => {
                module.classList.remove('active');
            });
            
            // Show target module
            document.getElementById(`module${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else {
                    stepEl.classList.remove('completed');
                }
            });
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            appState.currentStep = step;
            updateProgress();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgress() {
            const progress = ((appState.currentStep - 1) / 3) * 100;
            document.getElementById('progressLine').style.width = `${progress}%`;
        }

        // ===== MODULE 1: CUSTOMER INTAKE =====
        function submitIntake() {
            const form = document.getElementById('intakeForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Validate at least one electric utility is selected
            const electricUtilities = Array.from(document.querySelectorAll('input[name="utilityElectric"]:checked')).map(cb => cb.value);
            const gasUtilities = Array.from(document.querySelectorAll('input[name="utilityGas"]:checked')).map(cb => cb.value);
            
            if (electricUtilities.length === 0) {
                alert('Please select at least one electric utility provider.');
                return;
            }

            // Gather customer data
            const prioritizedConcerns = getPrioritizedConcerns();
            const priorityCommunities = Array.from(document.querySelectorAll('input[name="priorityCommunity"]:checked')).map(cb => cb.value);
            const workingWithCBO = document.getElementById('workingWithCBO').value === 'yes';
            const cboName = workingWithCBO ? document.getElementById('cboName').value : null;
            
            appState.customerData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                county: document.getElementById('county').value,
                electricUtilities: electricUtilities,
                gasUtilities: gasUtilities,
                allUtilities: [...electricUtilities, ...gasUtilities],
                housingType: document.getElementById('housingType').value,
                ownershipStatus: document.getElementById('ownershipStatus').value,
                prioritizedConcerns: prioritizedConcerns,
                concerns: prioritizedConcerns.map(c => c.id), // Legacy format for compatibility
                urgency: document.getElementById('urgency').value,
                priorityCommunities: priorityCommunities,
                workingWithCBO: workingWithCBO,
                cboName: cboName,
                timestamp: new Date().toISOString()
            };

            // Generate customer ID
            appState.customerData.customerId = generateCustomerId();
            
            // Show customer ID in next module
            document.getElementById('customerId').textContent = appState.customerData.customerId;
            document.getElementById('customerIdDisplay').style.display = 'block';

            // Pre-fill county in income module
            const countyFromIntake = document.getElementById('county').value;
            
            goToStep(2);
        }

        function generateCustomerId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 7);
            return `OR-${timestamp}-${random}`.toUpperCase();
        }
        
        function toggleCBODetails() {
            const workingWithCBO = document.getElementById('workingWithCBO').value === 'yes';
            const cboDetailsGroup = document.getElementById('cboDetailsGroup');
            cboDetailsGroup.style.display = workingWithCBO ? 'block' : 'none';
            if (!workingWithCBO) {
                document.getElementById('cboName').value = '';
            }
        }

        // ===== MODULE 2: INCOME QUALIFICATION =====
        function calculateIncome() {
            const form = document.getElementById('incomeForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const income = parseFloat(document.getElementById('income').value);
            const frequency = document.getElementById('frequency').value;
            const taxStatus = document.querySelector('input[name="taxStatus"]:checked').value;
            const householdSize = parseInt(document.getElementById('householdSize').value);
            const county = appState.customerData.county;

            // Convert to annual income
            const annualIncome = convertToAnnual(income, frequency, taxStatus);

            // Calculate percentages
            const percentages = calculatePercentages(annualIncome, county, householdSize);

            // Store income data
            appState.incomeData = {
                householdSize,
                annualIncome,
                percentages,
                county
            };

            // Determine eligibility with priority community consideration
            const isPriorityCommunity = appState.customerData.priorityCommunities && appState.customerData.priorityCommunities.length > 0;
            const workingWithCBO = appState.customerData.workingWithCBO;
            
            appState.eligibilityResults = {
                // Core income-based programs
                liheap: percentages.fpl <= 150,
                // CORRECTED: Weatherization uses ‚â§60% SMI (not AMI) or ‚â§200% FPL
                weatherization: percentages.smi <= 60 || percentages.fpl <= 200,
                
                // CPF eligibility: <150% AMI + (priority community OR CBO)
                cpfEligible: percentages.ami < 150 && (isPriorityCommunity || workingWithCBO),
                
                // Standard income-qualified
                energyTrust: percentages.ami <= 80,
                lowIncomeHousing: percentages.ami <= 80,
                firstTimeHomebuyer: percentages.ami <= 120,
                
                // HEAR eligibility - ALL INCOME TIERS can access HEAR
                hearLowIncome: percentages.ami > 60 && percentages.ami <= 80,    // 100% HEAR
                hearModerate: percentages.ami > 80 && percentages.ami <= 150,    // 50% HEAR
                hearWeatherization: percentages.smi <= 60 || percentages.fpl <= 200,  // Can access HEAR even with OHCS
                
                // HOMES eligibility - ALL INCOME TIERS can access HOMES
                homesEligible: percentages.ami <= 400,  // Up to 400% AMI eligible
                homesWeatherization: percentages.smi <= 60 || percentages.fpl <= 200,  // Can access HOMES even with OHCS
                
                // Market rate
                standardPrograms: percentages.ami > 150,
                
                // Priority flags
                isPriorityCommunity: isPriorityCommunity,
                workingWithCBO: workingWithCBO
            };

            // Display results
            displayIncomeResults(annualIncome, percentages, householdSize);
        }
        function convertToAnnual(amount, frequency, taxStatus) {
            let annualAmount = amount;
            
            switch(frequency) {
                case 'monthly': annualAmount = amount * 12; break;
                case 'biweekly': annualAmount = amount * 26; break;
                case 'weekly': annualAmount = amount * 52; break;
            }
            
            if (taxStatus === 'posttax') {
                annualAmount = annualAmount * 1.25;
            }
            
            return Math.round(annualAmount);
        }

        function calculatePercentages(annualIncome, county, householdSize) {
            const countyAMI = oregonCounties[county].ami;
            const adjustment = householdAdjustments[householdSize];
            const adjustedAMI = countyAMI * adjustment;
            const adjustedSMI = oregonSMI * adjustment;
            const fplAmount = fplData[householdSize];
            
            return {
                ami: Math.round((annualIncome / adjustedAMI) * 100),
                smi: Math.round((annualIncome / adjustedSMI) * 100),
                fpl: Math.round((annualIncome / fplAmount) * 100),
                adjustedAMI,
                adjustedSMI,
                fplAmount
            };
        }

        function displayIncomeResults(annualIncome, percentages, householdSize) {
            const summaryHTML = `
                <div class="summary-card ${percentages.ami <= 80 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.ami}%</div>
                    <div class="summary-label">Area Median Income</div>
                </div>
                <div class="summary-card ${percentages.smi <= 60 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.smi}%</div>
                    <div class="summary-label">State Median Income</div>
                </div>
                <div class="summary-card ${percentages.fpl <= 150 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.fpl}%</div>
                    <div class="summary-label">Federal Poverty Level</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">$${annualIncome.toLocaleString()}</div>
                    <div class="summary-label">Annual Income</div>
                </div>
            `;
            
            document.getElementById('incomeSummary').innerHTML = summaryHTML;

            const eligibility = appState.eligibilityResults;
            
            let priorityBadges = '';
            if (eligibility.isPriorityCommunity) {
                const communities = appState.customerData.priorityCommunities.map(c => c.replace(/_/g, ' ')).join(', ');
                priorityBadges += `<span class="badge badge-warning">‚≠ê Priority Community: ${communities}</span>`;
            }
            if (eligibility.workingWithCBO && appState.customerData.cboName) {
                priorityBadges += `<span class="badge badge-info">ü§ù CBO Partner: ${appState.customerData.cboName}</span>`;
            }
            
            const programHTML = `
                <div class="info-panel">
                    <h4>Program Eligibility Summary</h4>
                    ${priorityBadges ? `<div style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px;"><strong>Priority Status:</strong><br>${priorityBadges}</div>` : ''}
                    <div style="margin-top: 1rem;">
                        ${eligibility.weatherization ? '<span class="badge badge-success">‚úì Oregon Weatherization (NO COST - ‚â§60% SMI or ‚â§200% FPL) ‚ö†Ô∏è Check waitlist</span>' : ''}
                        ${eligibility.cpfEligible ? '<span class="badge badge-success">‚úì Community Partner Fund (CPF) - Enhanced Incentives</span>' : ''}
                        ${eligibility.liheap ? '<span class="badge badge-success">‚úì LIHEAP Bill Assistance (‚â§150% FPL)</span>' : ''}
                        ${eligibility.energyTrust ? '<span class="badge badge-success">‚úì Energy Trust Income-Qualified (‚â§80% AMI)</span>' : ''}
                        ${(eligibility.hearLowIncome || eligibility.hearModerate || eligibility.hearWeatherization) ? '<span class="badge badge-success">‚úì HEAR (IRA Federal) - All income tiers eligible</span>' : ''}
                        ${eligibility.homesEligible ? '<span class="badge badge-success">‚úì HOMES Whole-Home Rebate (IRA Federal) - All income tiers eligible</span>' : ''}
                        ${eligibility.standardPrograms ? '<span class="badge badge-info">Standard Energy Trust Programs Available</span>' : ''}
                    </div>
                    ${eligibility.weatherization ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>‚ö†Ô∏è Important:</strong> Oregon Weatherization may have waitlists. Check agency capacity. 
                            Meanwhile, you can also access HOMES/HEAR programs for faster upgrades.
                        </div>
                    ` : ''}
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                        <strong>Your Eligibility Tier:</strong> 
                        ${eligibility.weatherization ? '<span style="color: #155724; font-size: 1.1rem;">üéâ NO-COST WEATHERIZATION (+ HOMES/HEAR available)</span>' : 
                          eligibility.cpfEligible ? '<span style="color: #155724; font-size: 1.1rem;">‚≠ê ENHANCED INCENTIVES (CPF + HOMES/HEAR)</span>' : 
                          eligibility.hearModerate ? '<span style="color: #0c5460; font-size: 1.1rem;">üí∞ MODERATE INCOME (Standard + HEAR/HOMES)</span>' :
                          '<span style="color: #0c5460; font-size: 1.1rem;">üìä STANDARD PROGRAMS</span>'}
                    </div>
                </div>
            `;
            
            document.getElementById('programEligibility').innerHTML = programHTML;
            
            document.getElementById('incomeForm').style.display = 'none';
            document.getElementById('incomeResults').style.display = 'block';
        }

        // ===== MODULE 3: ENERGY ASSESSMENT =====
        function analyzeAssessment() {
            // Gather assessment data
            appState.assessmentData = {
                homeSquareFootage: document.getElementById('homeSquareFootage').value,
                conditionedSpace: document.getElementById('conditionedSpace').value,
                foundationType: document.getElementById('foundationType').value,
                roofCondition: document.getElementById('roofCondition').value,
                atticInsulation: document.getElementById('atticInsulation').value,
                wallInsulation: document.getElementById('wallInsulation').value,
                windowType: document.getElementById('windowType').value,
                doorSealing: document.getElementById('doorSealing').value,
                heatingType: document.getElementById('heatingType').value,
                heatingAge: document.getElementById('heatingAge').value,
                coolingType: document.getElementById('coolingType').value,
                ductwork: document.getElementById('ductwork').value,
                healthSafety: Array.from(document.querySelectorAll('input[name="healthSafety"]:checked')).map(cb => cb.value)
            };

            // Analyze and generate recommendations
            generateRecommendations();
            
            // Display assessment summary
            displayAssessmentSummary();
            
            document.getElementById('assessmentForm').style.display = 'none';
            document.getElementById('assessmentResults').style.display = 'block';
        }

        function generateRecommendations() {
            const data = appState.assessmentData;
            const recommendations = [];
            let priority = 1;

            // Health & Safety first
            if (data.healthSafety.length > 0 && !data.healthSafety.includes('none')) {
                recommendations.push({
                    priority: 'üî¥',
                    measure: 'Health & Safety Assessment',
                    description: 'Address health and safety concerns before proceeding with other upgrades',
                    estimatedCost: 'Varies',
                    incentive: 'May be covered under weatherization program',
                    dependencies: 'Required before weatherization work'
                });
            }

            // Insulation recommendations
            if (data.atticInsulation === 'none' || data.atticInsulation === 'poor') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const cost = sqft * 2.5;
                const incentive = sqft * 0.15;
                recommendations.push({
                    priority: 'üü†',
                    measure: 'Attic Insulation',
                    description: `Upgrade attic insulation to R-49 (~${sqft} sq ft)`,
                    estimatedCost: `$${cost.toLocaleString()}`,
                    incentive: `$${Math.round(incentive).toLocaleString()} Energy Trust rebate`,
                    dependencies: 'Roof in good condition'
                });
            }

            if (data.wallInsulation === 'none' || data.wallInsulation === 'partial') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const wallSqft = Math.round(sqft * 0.6);
                const cost = wallSqft * 3.5;
                const incentive = wallSqft * 0.10;
                recommendations.push({
                    priority: 'üü†',
                    measure: 'Wall Insulation',
                    description: `Add wall insulation (~${wallSqft} sq ft)`,
                    estimatedCost: `$${cost.toLocaleString()}`,
                    incentive: `$${Math.round(incentive).toLocaleString()} Energy Trust rebate`,
                    dependencies: 'None'
                });
            }

            // HVAC recommendations - Differentiate ducted vs ductless based on existing ductwork
            const heatingAge = parseInt(data.heatingAge) || 0;
            if (heatingAge > 15 || data.heatingType === 'baseboard' || data.heatingType === 'electric_furnace') {
                const hasGoodDucts = data.ductwork === 'good' || data.ductwork === 'fair';
                const conditionedSpace = parseInt(data.conditionedSpace) || 1800;
                
                if (hasGoodDucts && (data.heatingType === 'electric_furnace' || data.heatingType === 'gas_furnace')) {
                    // Recommend ducted heat pump for homes with existing duct system
                    const cost = 15000;
                    recommendations.push({
                        priority: 'üü°',
                        measure: 'Heat Pump System',
                        description: `Install ducted (central) heat pump system to utilize existing ductwork`,
                        estimatedCost: `$${cost.toLocaleString()}`,
                        incentive: `$1,500+ Energy Trust + utility incentives`,
                        dependencies: 'Duct sealing recommended first'
                    });
                } else {
                    // Recommend ductless for homes without ducts or with poor duct condition
                    const units = Math.ceil(conditionedSpace / 900);
                    const cost = units * 8000;
                    const incentive = units * 500;
                    recommendations.push({
                        priority: 'üü°',
                        measure: 'Heat Pump System',
                        description: `Install ${units} ductless heat pump unit(s) - no ductwork needed`,
                        estimatedCost: `$${cost.toLocaleString()}`,
                        incentive: `$${incentive.toLocaleString()} Energy Trust + utility incentives`,
                        dependencies: 'Insulation upgrades recommended first'
                    });
                }
            }

            // Windows
            if (data.windowType === 'single') {
                recommendations.push({
                    priority: 'üü°',
                    measure: 'Window Upgrades',
                    description: 'Replace single-pane windows with double-pane Energy Star windows',
                    estimatedCost: '$5,000 - $15,000',
                    incentive: 'Potential tax credits available',
                    dependencies: 'None'
                });
            }

            // Air sealing
            if (data.doorSealing === 'poor') {
                recommendations.push({
                    priority: 'üü¢',
                    measure: 'Air Sealing',
                    description: 'Professional air sealing and weatherstripping',
                    estimatedCost: '$500 - $2,000',
                    incentive: 'May be included in weatherization program',
                    dependencies: 'Should be done with insulation work'
                });
            }

            appState.recommendations = recommendations;
        }

        function displayAssessmentSummary() {
            const data = appState.assessmentData;
            const issues = countIssues(data);
            
            const summaryHTML = `
                <div class="summary-card">
                    <div class="summary-value">${appState.recommendations.length}</div>
                    <div class="summary-label">Recommendations</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${issues}</div>
                    <div class="summary-label">Potential Issues</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${calculateTotalIncentives()}</div>
                    <div class="summary-label">Estimated Incentives</div>
                </div>
            `;
            
            document.getElementById('assessmentSummary').innerHTML = summaryHTML;

            if (appState.recommendations.length > 0) {
                let tableHTML = `
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Recommended Energy Upgrades</h3>
                    <table class="recommendations-table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Measure</th>
                                <th>Description</th>
                                <th>Est. Cost</th>
                                <th>Incentives</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                appState.recommendations.forEach(rec => {
                    tableHTML += `
                        <tr>
                            <td style="font-size: 1.5rem; text-align: center;">${rec.priority}</td>
                            <td><strong>${rec.measure}</strong></td>
                            <td>${rec.description}<br><small style="color: var(--muted);">${rec.dependencies}</small></td>
                            <td><strong>${rec.estimatedCost}</strong></td>
                            <td style="color: var(--success);">${rec.incentive}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('assessmentRecommendations').innerHTML = tableHTML;
            }
        }

        function countIssues(data) {
            let count = 0;
            if (data.atticInsulation === 'poor' || data.atticInsulation === 'none') count++;
            if (data.wallInsulation === 'none' || data.wallInsulation === 'partial') count++;
            if (data.windowType === 'single') count++;
            if (data.doorSealing === 'poor') count++;
            if (parseInt(data.heatingAge) > 15) count++;
            if (data.healthSafety.length > 0 && !data.healthSafety.includes('none')) count++;
            return count;
        }

        function calculateTotalIncentives() {
            let total = 0;
            appState.recommendations.forEach(rec => {
                const match = rec.incentive.match(/\$([0-9,]+)/);
                if (match) {
                    total += parseInt(match[1].replace(/,/g, ''));
                }
            });
            return `$${total.toLocaleString()}`;
        }

        function editAssessment() {
            document.getElementById('assessmentForm').style.display = 'block';
            document.getElementById('assessmentResults').style.display = 'none';
        }

        // ===== MODULE 4: COMPREHENSIVE INSIGHTS =====
        function showComprehensiveResults() {
            try {
                // Initialize IncentiveRules engine
                const incentiveRules = new IncentiveRules();
                
                // Get customer eligibility tier
                const amiPercent = appState.incomeData.percentages.ami;
                const smiPercent = appState.incomeData.percentages.smi;
                const fplPercent = appState.incomeData.percentages.fpl;
                const eligibilityTier = incentiveRules.getEligibilityTier(amiPercent, smiPercent, fplPercent);
                
                // Build comprehensive results with tier info
                const tierDescription = incentiveRules.getTierDescription(eligibilityTier);
                
                // Calculate incentives for each recommended measure
                const enrichedRecommendations = appState.recommendations.map(rec => {
                    // Map measure names to IDs
                    const measureId = mapMeasureToId(rec.measure);
                    
                    if (measureId) {
                        const measureDetails = {
                            housingType: appState.customerData.housingType,
                            sqft: parseInt(appState.assessmentData.homeSquareFootage) || 2000,
                            cpfEligible: eligibility.cpfEligible || false
                        };
                        
                        const packages = incentiveRules.getIncentiveForMeasure(measureId, eligibilityTier, measureDetails);
                        
                        // Parse estimated cost
                        const costMatch = rec.estimatedCost.match(/\$([0-9,]+)/);
                        const estimatedCost = costMatch ? parseInt(costMatch[1].replace(/,/g, '')) : 5000;
                        
                        // Get best package and calculate costs
                        const bestPackage = incentiveRules.getBestPackage(packages, estimatedCost);
                        const costCalc = incentiveRules.calculateNetCost(estimatedCost, bestPackage);
                        
                        return {
                            ...rec,
                            measureId: measureId,
                            packages: packages,
                            bestPackage: bestPackage,
                            totalIncentives: costCalc.totalIncentives,
                            netCost: costCalc.netCost,
                            coverage: costCalc.coverage,
                            estimatedCostNum: estimatedCost,
                            selected: true // Default to selected
                        };
                    }
                    
                    return rec;
                });
                
                // Store enriched data
                appState.enrichedRecommendations = enrichedRecommendations;
                appState.eligibilityTier = eligibilityTier;
                
                // Generate and display HTML
                displayEnrichedResults(tierDescription, enrichedRecommendations);
                
            } catch (error) {
                console.error('Error generating comprehensive results:', error);
                // Fallback to basic display
                showBasicResults();
            }
        }
        
        function mapMeasureToId(measureName) {
            const mapping = {
                'Attic Insulation': 'attic_insulation',
                'Wall Insulation': 'wall_insulation',
                'Floor Insulation': 'floor_insulation',
                'Heat Pump System': 'heat_pump_ductless',
                'Window Upgrades': 'window_replacement',
                'Air Sealing': 'air_sealing',
                'Duct Sealing': 'duct_sealing',
                'Heat Pump Water Heater': 'heat_pump_water_heater',
                'Smart Thermostat': 'smart_thermostat',
                'Electric Panel Upgrade': 'electric_panel_upgrade'
            };
            return mapping[measureName] || null;
        }
        
        function displayEnrichedResults(tierDescription, recommendations) {
            const customer = appState.customerData;
            const income = appState.incomeData;
            const eligibility = appState.eligibilityResults;
            
            let html = `
                <div class="customer-id-display">
                    <div class="id-label">Assessment ID</div>
                    <div class="id-value">${customer.customerId}</div>
                </div>

                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Your Personalized Energy Pathway</h3>
                
                <div class="alert alert-success">
                    <h4 style="margin-bottom: 0.5rem;">${tierDescription}</h4>
                    <p><strong>Profile:</strong> ${customer.firstName} ${customer.lastName} | 
                    ${income.householdSize} person household | 
                    ${customer.county} | ${income.percentages.ami}% AMI</p>
                </div>
            `;
            
            // Priority community status
            if (eligibility.isPriorityCommunity || eligibility.workingWithCBO) {
                html += `
                    <div class="info-panel" style="background: #fff3cd; border-left-color: #ffc107;">
                        <h4>‚≠ê Priority Community Benefits</h4>
                        <p>You qualify for enhanced programs:</p>
                        <ul style="margin-left: 1.5rem; line-height: 1.8;">
                            ${eligibility.cpfEligible ? '<li><strong>Community Partner Fund (CPF)</strong> - Higher rebates for all measures</li>' : ''}
                            ${eligibility.hearLowIncome ? '<li><strong>HEAR 100%</strong> - Full federal rebates on electrification</li>' : ''}
                            ${eligibility.hearModerate ? '<li><strong>HEAR 50%</strong> - Federal rebates on electrification</li>' : ''}
                            ${eligibility.workingWithCBO && customer.cboName ? `<li><strong>CBO Partnership</strong> - Working with ${customer.cboName}</li>` : ''}
                        </ul>
                    </div>
                `;
            }
            
            // Recommendations table with selection checkboxes
            if (recommendations.length > 0) {
                html += `
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Prioritized Retrofit Plan with Your Incentives</h3>
                    <div class="alert alert-info">
                        <strong>üí° Tip:</strong> Check the boxes to select priority measures for your customized report. 
                        We'll generate two cost summaries: one for selected measures only, and one for the full scope.
                    </div>
                    <table class="recommendations-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Select</th>
                                <th>Priority</th>
                                <th>Measure</th>
                                <th>Est. Cost</th>
                                <th>Best Package</th>
                                <th>Coverage</th>
                                <th>Net Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                recommendations.forEach((rec, idx) => {
                    let packageDetails = '';
                    
                    if (rec.bestPackage && rec.bestPackage.incentives) {
                        packageDetails = `<strong>${rec.bestPackage.name}</strong><br>`;
                        packageDetails += rec.bestPackage.incentives.map(inc => {
                            const amount = typeof inc.amount === 'number' ? `$${inc.amount.toLocaleString()}` : inc.amount;
                            return `<div style="margin: 0.25rem 0; font-size: 0.85rem;">${inc.program}: ${amount}</div>`;
                        }).join('');
                        
                        if (rec.bestPackage.note) {
                            packageDetails += `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--muted); font-style: italic;">${rec.bestPackage.note}</div>`;
                        }
                        
                        // Show alternative packages if available
                        if (rec.packages && rec.packages.length > 1) {
                            packageDetails += `<button onclick="showPackageOptions(${idx})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">View ${rec.packages.length} package options</button>`;
                        }
                    } else {
                        packageDetails = '<em>See program details</em>';
                    }
                    
                    const coverage = rec.coverage ? `${rec.coverage}%` : 'N/A';
                    const netCost = rec.netCost !== undefined ? `$${rec.netCost.toLocaleString()}` : rec.estimatedCost;
                    
                    html += `
                        <tr id="measure-row-${idx}">
                            <td style="text-align: center;">
                                <input type="checkbox" class="measure-checkbox" data-idx="${idx}" 
                                       onchange="toggleMeasureSelection(${idx})" 
                                       ${rec.selected ? 'checked' : ''}
                                       style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--brand);">
                            </td>
                            <td style="font-size: 1.5rem; text-align: center;">${rec.priority}</td>
                            <td><strong>${rec.measure}</strong><br><small style="color: var(--muted);">${rec.description}</small></td>
                            <td><strong>${rec.estimatedCost}</strong></td>
                            <td style="color: var(--success); font-size: 0.9rem;">${packageDetails}</td>
                            <td><strong style="color: var(--brand);">${coverage}</strong></td>
                            <td><strong style="font-size: 1.1rem;">${netCost}</strong></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    
                    <div id="costSummary" style="margin-top: 2rem;">
                        ${generateCostSummary(recommendations)}
                    </div>
                `;
            }
            
            // Next steps
            html += generateNextStepsSection(eligibility);
            
            // Priority concerns
            if (customer.prioritizedConcerns && customer.prioritizedConcerns.length > 0) {
                html += generatePriorityConcernsSection(customer.prioritizedConcerns);
            }
            
            document.getElementById('comprehensiveResults').innerHTML = html;
        }
        
        function toggleMeasureSelection(idx) {
            if (appState.enrichedRecommendations && appState.enrichedRecommendations[idx]) {
                appState.enrichedRecommendations[idx].selected = !appState.enrichedRecommendations[idx].selected;
                updateCostSummary();
            }
        }
        
        function updateCostSummary() {
            const summaryDiv = document.getElementById('costSummary');
            if (summaryDiv && appState.enrichedRecommendations) {
                summaryDiv.innerHTML = generateCostSummary(appState.enrichedRecommendations);
            }
        }
        
        function generateCostSummary(recommendations) {
            const selected = recommendations.filter(r => r.selected);
            const all = recommendations;
            
            // Calculate selected totals
            let selectedCost = 0;
            let selectedIncentives = 0;
            selected.forEach(r => {
                selectedCost += r.estimatedCostNum || 0;
                selectedIncentives += r.totalIncentives || 0;
            });
            const selectedNet = selectedCost - selectedIncentives;
            
            // Calculate full scope totals
            let fullCost = 0;
            let fullIncentives = 0;
            all.forEach(r => {
                fullCost += r.estimatedCostNum || 0;
                fullIncentives += r.totalIncentives || 0;
            });
            const fullNet = fullCost - fullIncentives;
            
            return `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Cost Summary</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--success);">
                        <h4 style="color: var(--brand); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ‚úÖ Selected Measures (${selected.length})
                        </h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600;">Total Cost:</span>
                                <span style="font-size: 1.1rem; font-weight: bold;">$${selectedCost.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600; color: var(--success);">Total Incentives:</span>
                                <span style="font-size: 1.1rem; font-weight: bold; color: var(--success);">-$${selectedIncentives.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--brand); color: white; border-radius: 8px; margin-top: 0.5rem;">
                                <span style="font-weight: bold; font-size: 1.1rem;">Your Net Cost:</span>
                                <span style="font-size: 1.3rem; font-weight: bold;">$${selectedNet.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
                                ${Math.round((selectedIncentives / selectedCost) * 100) || 0}% covered by incentives
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--accent);">
                        <h4 style="color: var(--accent-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìä Full Scope (${all.length} measures)
                        </h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600;">Total Cost:</span>
                                <span style="font-size: 1.1rem; font-weight: bold;">$${fullCost.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600; color: var(--success);">Total Incentives:</span>
                                <span style="font-size: 1.1rem; font-weight: bold; color: var(--success);">-$${fullIncentives.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--accent); color: white; border-radius: 8px; margin-top: 0.5rem;">
                                <span style="font-weight: bold; font-size: 1.1rem;">Your Net Cost:</span>
                                <span style="font-size: 1.3rem; font-weight: bold;">$${fullNet.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
                                ${Math.round((fullIncentives / fullCost) * 100) || 0}% covered by incentives
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showPackageOptions(idx) {
            const rec = appState.enrichedRecommendations[idx];
            if (!rec || !rec.packages) return;
            
            let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <h3 style="color: var(--brand); margin-bottom: 1rem;">${rec.measure} - Package Options</h3>
                        <p style="color: var(--muted); margin-bottom: 1.5rem;">Choose the best incentive package for your situation:</p>
            `;
            
            rec.packages.forEach((pkg, pkgIdx) => {
                const costCalc = new IncentiveRules().calculateNetCost(rec.estimatedCostNum, pkg);
                const isBest = pkg === rec.bestPackage;
                
                html += `
                    <div style="background: ${isBest ? 'linear-gradient(135deg, #d4edda, #c3e6cb)' : '#f9fafb'}; border: 2px solid ${isBest ? 'var(--success)' : '#e5e7eb'}; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: var(--brand); margin: 0;">${pkg.name} ${isBest ? '‚≠ê RECOMMENDED' : ''}</h4>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: var(--muted);">Net Cost</div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: var(--brand);">$${costCalc.netCost.toLocaleString()}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                `;
                
                pkg.incentives.forEach(inc => {
                    const amount = typeof inc.amount === 'number' ? `$${inc.amount.toLocaleString()}` : inc.amount;
                    html += `
                        <div style="padding: 0.5rem; background: white; border-radius: 5px; margin: 0.5rem 0;">
                            <strong>${inc.program}:</strong> ${amount}
                            ${inc.note ? `<br><small style="color: var(--muted);">${inc.note}</small>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        ${pkg.note ? `<div style="color: var(--muted); font-style: italic; font-size: 0.9rem;">üí° ${pkg.note}</div>` : ''}
                    </div>
                `;
            });
            
            html += `
                        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="padding: 0.75rem 2rem; background: var(--brand); color: white; border: none; border-radius: 999px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 1rem;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function generateNextStepsSection(eligibility) {
            let html = `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Next Steps & Resources</h3>
                <div class="form-grid">
            `;
            
            if (eligibility.weatherization) {
                html += `
                    <div class="info-panel">
                        <h4>üéâ Oregon Weatherization (PRIORITY)</h4>
                        <p><strong>Phone:</strong> 1-800-766-6861<br>
                        <strong>Website:</strong> oregon.gov/ohcs/energy-weatherization<br>
                        <strong>Action:</strong> Apply immediately for no-cost comprehensive upgrades</p>
                    </div>
                `;
            }
            
            if (eligibility.cpfEligible) {
                html += `
                    <div class="info-panel">
                        <h4>‚≠ê Community Partner Fund (CPF)</h4>
                        <p><strong>Contact:</strong> Energy Trust Community Partner<br>
                        <strong>Website:</strong> energytrust.org/cpf<br>
                        <strong>Action:</strong> Work with your CBO or find a partner to access enhanced rebates</p>
                    </div>
                `;
            }
            
            html += `
                <div class="info-panel">
                    <h4>‚ö° Energy Trust of Oregon</h4>
                    <p><strong>Phone:</strong> 1-866-368-7878<br>
                    <strong>Website:</strong> energytrust.org<br>
                    <strong>Action:</strong> Find Trade Ally contractors at energytrust.org/find-a-contractor</p>
                </div>
            `;
            
            if (eligibility.hearLowIncome || eligibility.hearModerate) {
                html += `
                    <div class="info-panel">
                        <h4>üá∫üá∏ HEAR Federal Program (IRA)</h4>
                        <p><strong>Phone:</strong> Oregon DOE 1-800-221-8035<br>
                        <strong>Website:</strong> oregon.gov/energy/incentives<br>
                        <strong>Action:</strong> Check availability - program launching in phases</p>
                    </div>
                `;
            }
            
            if (eligibility.liheap) {
                html += `
                    <div class="info-panel">
                        <h4>üíµ LIHEAP Bill Assistance</h4>
                        <p><strong>Contact:</strong> Local Community Action Agency<br>
                        <strong>Action:</strong> Get help with energy bills while planning upgrades</p>
                    </div>
                `;
            }
            
            html += `
                </div>
            `;
            
            return html;
        }
        
        function generatePriorityConcernsSection(concerns) {
            let html = `
                <div class="alert alert-info" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 0.5rem;">üéØ Your Priority Concerns (Ranked)</h4>
                    <div style="margin-top: 1rem;">
            `;
            
            concerns.forEach((concern, idx) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 8px; border-left: 4px solid var(--brand);">
                        <span style="background: var(--brand); color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">#${idx + 1}</span>
                        <span style="font-size: 1.2rem;">${concern.icon}</span>
                        <span style="flex: 1; font-weight: 600;">${concern.text}</span>
                        <span style="color: var(--muted); font-size: 0.85rem;">Weight: ${concern.weight}</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.9rem;"><strong>Note:</strong> Our recommendations are prioritized to address your top concerns first.</p>
                </div>
            `;
            
            return html;
        }
        
        // Fallback basic results function
        function showBasicResults() {
            const eligibility = appState.eligibilityResults;
            const customer = appState.customerData;
            const income = appState.incomeData;
            
            let html = `
                <div class="customer-id-display">
                    <div class="id-label">Assessment ID</div>
                    <div class="id-value">${customer.customerId}</div>
                </div>

                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Your Personalized Energy Pathway</h3>
                
                <div class="alert alert-info">
                    <strong>Customer Profile:</strong> ${customer.firstName} ${customer.lastName} | 
                    ${income.householdSize} person household | 
                    ${customer.county} | 
                    ${customer.housingType.replace(/_/g, ' ')}
                </div>
            `;

            // Eligibility-based recommendations
            if (eligibility.weatherization && eligibility.liheap) {
                html += `
                    <div class="alert alert-success">
                        <h4 style="margin-bottom: 0.5rem;">üéâ You Qualify for Comprehensive Assistance!</h4>
                        <p>Based on your income, you're eligible for Oregon's weatherization program, which can provide many of the recommended upgrades at little to no cost.</p>
                    </div>
                    
                    <div class="info-panel">
                        <h4>Next Steps - Priority Path</h4>
                        <ol style="margin-left: 1.5rem; line-height: 2;">
                            <li><strong>Contact Oregon Weatherization Program</strong> - They can provide free energy assessments and upgrades</li>
                            <li><strong>Apply for LIHEAP</strong> - Get help with energy bills while waiting for upgrades</li>
                            <li><strong>Energy Trust of Oregon</strong> - Additional incentives may be available for income-qualified households</li>
                        </ol>
                    </div>
                `;
            } else if (eligibility.energyTrust) {
                html += `
                    <div class="alert alert-success">
                        <h4 style="margin-bottom: 0.5rem;">‚úì Energy Trust Income-Qualified Programs</h4>
                        <p>You qualify for enhanced incentives through Energy Trust of Oregon's income-qualified programs.</p>
                    </div>
                `;
            }

            // Add recommendations table
            if (appState.recommendations.length > 0) {
                html += `
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Prioritized Retrofit Plan</h3>
                    <table class="recommendations-table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Measure</th>
                                <th>Details</th>
                                <th>Cost</th>
                                <th>Your Incentives</th>
                                <th>Net Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                appState.recommendations.forEach(rec => {
                    // Adjust incentives based on eligibility
                    let incentiveText = rec.incentive;
                    if (eligibility.weatherization) {
                        incentiveText = 'Potentially fully covered by weatherization program';
                    }

                    html += `
                        <tr>
                            <td style="font-size: 1.5rem; text-align: center;">${rec.priority}</td>
                            <td><strong>${rec.measure}</strong></td>
                            <td>${rec.description}</td>
                            <td><strong>${rec.estimatedCost}</strong></td>
                            <td style="color: var(--success);">${incentiveText}</td>
                            <td><strong>${eligibility.weatherization ? '$0 - Low' : 'Varies'}</strong></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            }

            // Financing options
            html += `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Next Steps & Resources</h3>
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem; color: #666;">
                    <strong>‚ö†Ô∏è Important:</strong> This assessment tool is provided for informational purposes only and is not affiliated with or endorsed by any program listed. 
                    You must apply directly through official channels below to access programs and confirm eligibility. Incentive amounts are estimates and subject to program availability, 
                    funding levels, and administrator approval.
                </div>
                <div class="form-grid">
            `;
                        <h4>üìû Oregon Weatherization</h4>
                        <p>Phone: 1-800-766-6861<br>
                        Website: oregon.gov/ohcs/energy-weatherization</p>
                    </div>
                    <div class="info-panel">
                        <h4>‚ö° Energy Trust of Oregon</h4>
                        <p>Phone: 1-866-368-7878<br>
                        Website: energytrust.org</p>
                    </div>
                    <div class="info-panel">
                        <h4>üí∞ Financing Options</h4>
                        <p>${eligibility.weatherization ? 'Weatherization grants available' : 'Energy Trust financing programs'}</p>
                    </div>
                    <div class="info-panel">
                        <h4>üè† Local Contractors</h4>
                        <p>Find Energy Trust Trade Ally contractors at energytrust.org/find-a-contractor</p>
                    </div>
                </div>
            `;

            // Priority concerns from intake
            if (customer.prioritizedConcerns && customer.prioritizedConcerns.length > 0) {
                html += `
                    <div class="alert alert-info">
                        <h4 style="margin-bottom: 0.5rem;">üéØ Your Priority Concerns (Ranked)</h4>
                        <div style="margin-top: 1rem;">
                `;
                
                customer.prioritizedConcerns.forEach((concern, idx) => {
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 8px; border-left: 4px solid var(--brand);">
                            <span style="background: var(--brand); color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">#${idx + 1}</span>
                            <span style="font-size: 1.2rem;">${concern.icon}</span>
                            <span style="flex: 1; font-weight: 600;">${concern.text}</span>
                            <span style="color: var(--muted); font-size: 0.85rem;">Weight: ${concern.weight}</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem;"><strong>Note:</strong> Our recommendations are prioritized to address your top concerns first.</p>
                    </div>
                `;
            } else if (customer.concerns && customer.concerns.length > 0) {
                // Fallback for old format
                html += `
                    <div class="alert alert-info">
                        <h4 style="margin-bottom: 0.5rem;">Your Stated Concerns</h4>
                        <p>You indicated concerns about: <strong>${customer.concerns.map(c => c.replace(/_/g, ' ')).join(', ')}</strong></p>
                        <p>Our recommendations above specifically address these issues.</p>
                    </div>
                `;
            }

            document.getElementById('comprehensiveResults').innerHTML = html;
        }

        // When user reaches step 4, generate comprehensive results
        const originalGoToStep = goToStep;
        goToStep = function(step) {
            originalGoToStep(step);
            if (step === 4 && appState.recommendations.length > 0) {
                showComprehensiveResults();
            }
        };

        // ===== UTILITY FUNCTIONS =====
        function downloadReport() {
            // Use the comprehensive generated report if available, otherwise fallback
            let fullReport = appState.lastGeneratedReport;
            
            if (!fullReport) {
                const reportContent = document.getElementById('comprehensiveResults').innerHTML;
                fullReport = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Energy Assessment Report - ${appState.customerData.customerId}</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #2c5530; color: white; }
                            .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
                            .alert-success { background-color: #d4edda; border-left: 4px solid #28a745; }
                            .alert-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
                        </style>
                    </head>
                    <body>
                        <h1>Oregon Comprehensive Energy Assessment Report</h1>
                        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        ${reportContent}
                    </body>
                    </html>
                `;
            }
            
            const blob = new Blob([fullReport], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `energy-assessment-${appState.customerData.customerId}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startOver() {
            if (confirm('Are you sure you want to start a new assessment? Current data will be lost.')) {
                location.reload();
            }
        }
        
        // ===== DRAG AND DROP PRIORITY RANKING =====
        let draggedElement = null;
        
        function initializeDragAndDrop() {
            const pool = document.getElementById('concernsPool');
            const ranking = document.getElementById('priorityRanking');
            
            // Set up drag events for all concern cards
            document.querySelectorAll('.concern-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            // Set up drop zones
            [pool, ranking].forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
            
            // Allow dropping on cards too for reordering
            document.querySelectorAll('.concern-card').forEach(card => {
                card.addEventListener('dragover', handleDragOverCard);
                card.addEventListener('drop', handleDropOnCard);
            });
        }
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragOverCard(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            if (draggedElement && e.target.classList.contains('concerns-list')) {
                e.target.appendChild(draggedElement);
                updatePriorityRanks();
            }
            
            return false;
        }
        
        function handleDropOnCard(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            this.classList.remove('drag-over');
            
            if (draggedElement && this !== draggedElement) {
                const parent = this.parentNode;
                const allCards = [...parent.children].filter(el => el.classList.contains('concern-card'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const targetIndex = allCards.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
                
                updatePriorityRanks();
            }
            
            return false;
        }
        
        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }
        
        function updatePriorityRanks() {
            const ranking = document.getElementById('priorityRanking');
            const cards = ranking.querySelectorAll('.concern-card');
            
            cards.forEach((card, index) => {
                card.setAttribute('data-rank', `#${index + 1}`);
            });
        }
        
        function getPrioritizedConcerns() {
            const ranking = document.getElementById('priorityRanking');
            const cards = ranking.querySelectorAll('.concern-card');
            
            return Array.from(cards).map((card, index) => ({
                id: card.getAttribute('data-id'),
                icon: card.getAttribute('data-icon'),
                text: card.querySelector('.concern-text').textContent,
                rank: index + 1,
                weight: 7 - index // Top item gets 7, descending
            }));
        }
        
        // ===== DEMO DATA LOADER =====
        function loadDemoData() {
            // Customer Info
            document.getElementById('firstName').value = 'Jane';
            document.getElementById('lastName').value = 'Smith';
            document.getElementById('email').value = 'jane.smith@example.com';
            document.getElementById('phone').value = '503-555-1234';
            
            // County
            document.getElementById('county').value = 'Multnomah County';
            
            // Utilities - Select PGE and NW Natural
            document.querySelectorAll('input[name="utilityElectric"]').forEach(cb => {
                if (cb.value === 'pge') cb.checked = true;
            });
            document.querySelectorAll('input[name="utilityGas"]').forEach(cb => {
                if (cb.value === 'nw_natural') cb.checked = true;
            });
            
            // Housing
            document.getElementById('housingType').value = 'single_family';
            document.getElementById('ownershipStatus').value = 'own';
            
            // Priorities - Move top 3 concerns to ranking
            const concernsToRank = ['high_bills', 'comfort', 'old_equipment'];
            const pool = document.getElementById('concernsPool');
            const ranking = document.getElementById('priorityRanking');
            
            concernsToRank.forEach(concernId => {
                const card = pool.querySelector(`[data-id="${concernId}"]`);
                if (card) {
                    ranking.appendChild(card);
                }
            });
            updatePriorityRanks();
            
            // Urgency
            document.getElementById('urgency').value = 'high';
            
            alert('‚úÖ Demo data loaded! Review the form and click "Continue" to proceed.');
        }
    </script>
</body>
</html>