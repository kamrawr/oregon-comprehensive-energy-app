<!DOCTYPE html>
<!--
═══════════════════════════════════════════════════════════════════════════
  Oregon Comprehensive Energy Assessment Tool
  
  Copyright © 2025 Isaiah Kamrar / Community Consulting Partners LLC
  All Rights Reserved.
  
  PROPRIETARY SOFTWARE - NOT OPEN SOURCE
  
  This software is protected by copyright law and international treaties.
  Unauthorized reproduction, distribution, modification, or use is 
  strictly prohibited and may result in severe civil and criminal penalties.
  
  For licensing inquiries:
  Isaiah Kamrar
  Community Consulting Partners LLC
  Email: dikamrar@gmail.com
  
  Non-profit & government agencies: Free licensing available
  Commercial use: Paid license required
  
  See LICENSE.md for full terms and conditions.
═══════════════════════════════════════════════════════════════════════════
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oregon Comprehensive Energy Assessment</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
    <script src="src/income_data_loader.js"></script>
    <script src="src/data_loader.js"></script>
    <script src="src/config_loader.js"></script>
    <script src="src/incentive_rules.js"></script>
    <script src="src/incentive_calculator.js"></script>
    <script src="src/report_generator.js"></script>
    <style>
        :root {
            --brand: #2c5530;
            --brand-light: #5cb85c;
            --accent: #3282b8;
            --accent-dark: #0f4c75;
            --bg: #f5f7fb;
            --card: #ffffff;
            --text: #2e2e2e;
            --muted: #6b7280;
            --success: #28a745;
            --warning: #fd7e14;
            --danger: #dc3545;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 2rem;
            text-align: center;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            margin-bottom: 2rem;
        }

        .app-header h1 {
            color: var(--brand);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .app-header .subtitle {
            color: var(--muted);
            font-size: 1.1rem;
        }

        /* Progress Steps */
        .progress-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e5e7eb;
            z-index: 0;
        }

        .progress-line {
            position: absolute;
            top: 25px;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--brand), var(--brand-light));
            z-index: 1;
            transition: width 0.5s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 2;
            flex: 1;
            cursor: pointer;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #9ca3af;
            transition: all 0.3s ease;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--muted);
            text-align: center;
            max-width: 120px;
        }

        .step.active .step-label {
            color: var(--brand);
        }

        /* Main Content Card */
        .main-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
            min-height: 600px;
        }

        .module {
            display: none;
        }

        .module.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .module-title {
            color: var(--brand);
            font-size: 2rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--brand-light);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--brand);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e1ecf4;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--brand-light);
            box-shadow: 0 0 0 4px rgba(92, 184, 92, 0.1);
            background: white;
        }

        .checkbox-group {
            display: grid;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background: #f3f4f6;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--brand-light);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 999px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand), var(--brand-light));
            color: white;
            box-shadow: 0 10px 25px rgba(92, 184, 92, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(92, 184, 92, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        /* Results/Summary Styles */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .summary-card.highlight {
            border-color: var(--brand-light);
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--brand);
            margin-bottom: 0.5rem;
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Eligibility badges */
        .badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 0.25rem;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Recommendations Table */
        .recommendations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .recommendations-table th {
            background: var(--brand);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .recommendations-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .recommendations-table tr:last-child td {
            border-bottom: none;
        }

        .recommendations-table tr:hover {
            background: #f9fafb;
        }

        /* Customer ID Display */
        .customer-id-display {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .customer-id-display .id-label {
            font-size: 0.9rem;
            color: #1565c0;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .customer-id-display .id-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d47a1;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--brand-light);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Boxes */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 1.8rem;
            }
            
            .progress-steps {
                flex-wrap: wrap;
            }

            .step {
                flex-basis: 50%;
                margin-bottom: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .main-card {
                padding: 1.5rem;
            }
        }

        /* Concern Cards - Drag and Drop */
        .concerns-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .concern-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .concern-card:hover {
            border-color: var(--brand);
            box-shadow: 0 4px 12px rgba(44, 85, 48, 0.15);
            transform: translateY(-2px);
        }
        
        .concern-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .concern-card.drag-over {
            border-style: dashed;
            border-color: var(--brand);
            background: rgba(92, 184, 92, 0.1);
        }
        
        .concern-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .concern-text {
            flex: 1;
            font-weight: 500;
            color: var(--text);
        }
        
        .concern-handle {
            color: #d1d5db;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .priority-list .concern-card {
            background: white;
            border-color: white;
            position: relative;
        }
        
        .priority-list .concern-card::before {
            content: attr(data-rank);
            position: absolute;
            left: -2.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: var(--brand);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(44, 85, 48, 0.3);
        }
        
        .priority-list .empty-state {
            pointer-events: none;
        }
        
        .priority-list:not(:empty) .empty-state {
            display: none;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 2rem 0;
        }

        /* Info Panel */
        .info-panel {
            background: #f8f9fa;
            border-left: 4px solid var(--brand-light);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .info-panel h4 {
            color: var(--brand);
            margin-bottom: 0.5rem;
        }

        .info-panel p {
            color: var(--muted);
            line-height: 1.6;
        }

        /* Priority indicators */
        .priority-high {
            color: var(--danger);
            font-weight: bold;
        }

        .priority-medium {
            color: var(--warning);
            font-weight: bold;
        }

        .priority-low {
            color: var(--info);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <div class="app-header">
            <div style="position: absolute; top: 1rem; right: 1rem;">
                <button onclick="loadFullDemoAndSkip()" class="btn" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 0.75rem 1.5rem;
                    font-weight: 600;
                    font-size: 0.95rem;
                    border: none;
                    border-radius: 999px;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                    ⚡ Quick Demo Mode
                </button>
            </div>
            <h1>🏠 Oregon Comprehensive Energy Assessment</h1>
            <p class="subtitle">Complete energy efficiency evaluation with personalized incentive pathways</p>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                Independent tool • Not affiliated with or endorsed by Energy Trust, OHCS, or Oregon DOE • For official eligibility, contact program administrators directly
            </p>
        </div>

        <!-- Progress Tracker -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line" id="progressLine"></div>
                <div class="step active" data-step="1" onclick="goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label">Customer Intake</div>
                </div>
                <div class="step" data-step="2" onclick="goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label">Income Qualification</div>
                </div>
                <div class="step" data-step="3" onclick="goToStep(3)">
                    <div class="step-circle">3</div>
                    <div class="step-label">Energy Assessment</div>
                </div>
                <div class="step" data-step="4" onclick="goToStep(4)">
                    <div class="step-circle">4</div>
                    <div class="step-label">Incentive Insights</div>
                </div>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="main-card">
            <!-- MODULE 1: Customer Intake -->
            <div class="module active" id="module1">
                <h2 class="module-title">Step 1: Customer Intake & Eligibility</h2>
                
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="loadDemoData()" style="float: right; padding: 0.5rem 1rem;">
                        📋 Load Demo Data
                    </button>
                    <h4 style="margin: 0 0 0.5rem 0;">Welcome to Your Energy Assessment</h4>
                    <p style="margin: 0;">Let's start by gathering some basic information to determine your eligibility for energy assistance programs and create your customer profile.</p>
                    <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: #666; font-style: italic;">
                        <strong>Note:</strong> This is an informational tool only. Program eligibility and incentive amounts must be confirmed directly with program administrators.
                    </p>
                    <div style="clear: both;"></div>
                </div>

                <form id="intakeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address *</label>
                            <input type="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" class="form-control">
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Geographic & Program Information</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="county">Oregon County *</label>
                            <select id="county" class="form-control" required>
                                <option value="">Select your county...</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Utility Providers (Select all that apply) *</label>
                            <div style="background: #f9fafb; border: 2px solid #e1ecf4; border-radius: 10px; padding: 1rem; margin-top: 0.5rem;">
                                <div style="margin-bottom: 1rem;">
                                    <strong style="color: var(--brand); display: block; margin-bottom: 0.5rem;">⚡ Electric Utilities</strong>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="pge">
                                            <span>Portland General Electric (PGE)</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="pacific_power">
                                            <span>Pacific Power</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="eweb">
                                            <span>Eugene Water & Electric Board (EWEB)</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityElectric" value="municipal">
                                            <span>Municipal Utility (City-owned)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: var(--brand); display: block; margin-bottom: 0.5rem;">🔥 Gas Utilities (Optional)</strong>
                                    <div class="checkbox-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="nw_natural">
                                            <span>NW Natural Gas</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="cascade">
                                            <span>Cascade Natural Gas</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="avista">
                                            <span>Avista</span>
                                        </label>
                                        <label class="checkbox-label">
                                            <input type="checkbox" name="utilityGas" value="propane">
                                            <span>Propane Only (No natural gas service)</span>
                                        </label>
                                    </div>
                                </div>
                                <small style="display: block; margin-top: 0.75rem; color: var(--muted);">✓ Must select at least one electric utility</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="housingType">Housing Type *</label>
                            <select id="housingType" class="form-control" required>
                                <option value="">Select housing type...</option>
                                <option value="single_family">Single Family Home</option>
                                <option value="multi_family">Multi-Family</option>
                                <option value="townhome">Townhome</option>
                                <option value="manufactured">Manufactured Home</option>
                                <option value="condo">Condominium</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ownershipStatus">Home Ownership *</label>
                            <select id="ownershipStatus" class="form-control" required>
                                <option value="">Select status...</option>
                                <option value="own">Own</option>
                                <option value="rent">Rent</option>
                                <option value="landlord">Landlord (Own but don't live there)</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">🎯 Priority Community & Program Access</h3>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: var(--brand); margin-bottom: 0.5rem; display: block;">
                            Priority Community Self-Identification (Optional but helps determine eligibility)
                        </label>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Select all that apply. This information helps us identify enhanced incentive programs you may qualify for.
                        </p>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="low_income">
                                <span>Low-Income Household</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="tribal">
                                <span>Tribal Member or Living on Tribal Land</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="rural">
                                <span>Rural Community</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="community_of_color">
                                <span>Community of Color</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="priorityCommunity" value="other_underserved">
                                <span>Other Underserved Community</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="workingWithCBO">Are you working with a Community-Based Organization (CBO)?</label>
                        <select id="workingWithCBO" class="form-control" onchange="toggleCBODetails()">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="cboDetailsGroup" style="display: none; grid-column: 1 / -1;">
                        <label for="cboName">Community Organization Name</label>
                        <input type="text" id="cboName" class="form-control" placeholder="Enter organization name">
                        <small style="color: var(--muted); display: block; margin-top: 0.5rem;">
                            Working with a CBO may enable access to Community Partner Fund (CPF) and no-cost weatherization programs.
                        </small>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 1.5rem;">
                            <label class="checkbox-label" style="background: transparent; padding: 0; cursor: pointer;">
                                <input type="checkbox" id="optOutFederalPrograms" style="width: 22px; height: 22px; accent-color: var(--brand-light);">
                                <span style="font-weight: 600; font-size: 1rem;">
                                    I want to opt out of federally-funded programs (CPF no-cost track, OHCS Weatherization, HEAR, HOMES)
                                </span>
                            </label>
                            <p style="color: #856404; font-size: 0.9rem; margin-top: 0.75rem; line-height: 1.5;">
                                <strong>Why opt out?</strong> Some people prefer not to participate in federal programs due to documentation requirements, waitlists, or personal preference. 
                                Checking this box will show you only state and utility-funded programs (Energy Trust of Oregon, state rebates, etc.).
                            </p>
                            <p style="color: #721c24; font-size: 0.85rem; margin-top: 0.5rem; font-style: italic;">
                                ⚠️ <strong>Note:</strong> Opting out may significantly reduce or eliminate available incentives, especially for income-qualified customers.
                            </p>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">🎯 Your Energy Priorities</h3>
                    
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.5rem; display: block;">
                            Rank Your Energy Concerns by Priority
                        </label>
                        <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1rem;">
                            Drag and drop the cards below to rank your concerns from highest (top) to lowest priority. Only include concerns that apply to your home.
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                            <!-- Available Concerns Pool -->
                            <div>
                                <h4 style="color: var(--brand); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: var(--secondary); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem;">?</span>
                                    Available Concerns
                                </h4>
                                <div id="concernsPool" class="concerns-list" style="min-height: 300px; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 8px; padding: 1rem;">
                                    <div class="concern-card" draggable="true" data-id="high_bills" data-icon="💰">
                                        <span class="concern-icon">💰</span>
                                        <span class="concern-text">High energy bills</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="comfort" data-icon="🌡️">
                                        <span class="concern-icon">🌡️</span>
                                        <span class="concern-text">Home comfort (too hot/cold)</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="drafts" data-icon="💨">
                                        <span class="concern-icon">💨</span>
                                        <span class="concern-text">Drafts and air leaks</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="old_equipment" data-icon="🔧">
                                        <span class="concern-icon">🔧</span>
                                        <span class="concern-text">Old/inefficient heating/cooling</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="insulation" data-icon="🏠">
                                        <span class="concern-icon">🏠</span>
                                        <span class="concern-text">Poor insulation</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="windows" data-icon="🪟">
                                        <span class="concern-icon">🪟</span>
                                        <span class="concern-text">Old/inefficient windows</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                    <div class="concern-card" draggable="true" data-id="health" data-icon="⚠️">
                                        <span class="concern-icon">⚠️</span>
                                        <span class="concern-text">Health and safety concerns</span>
                                        <span class="concern-handle">⋮⋮</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Priority Ranking Area -->
                            <div>
                                <h4 style="color: var(--brand); font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: var(--brand); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem;">→</span>
                                    Your Priority Ranking
                                </h4>
                                <div id="priorityRanking" class="concerns-list priority-list" style="min-height: 300px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 3px solid var(--brand); border-radius: 8px; padding: 1rem; position: relative;">
                                    <div class="empty-state" style="color: white; text-align: center; padding: 2rem 1rem; opacity: 0.8;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">👆</div>
                                        <p style="margin: 0; font-size: 0.95rem;">Drag concerns here to rank them</p>
                                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">#1 = Highest Priority</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="urgency">How urgent is your need for energy assistance?</label>
                        <select id="urgency" class="form-control">
                            <option value="immediate">Immediate - Critical need</option>
                            <option value="high">High - Need soon</option>
                            <option value="moderate">Moderate - Planning ahead</option>
                            <option value="low">Low - Exploring options</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="submitIntake()">
                            Continue to Income Qualification →
                        </button>
                    </div>
                </form>
            </div>

            <!-- MODULE 2: Income Qualification -->
            <div class="module" id="module2">
                <h2 class="module-title">Step 2: Income Qualification</h2>
                
                <div class="customer-id-display" id="customerIdDisplay" style="display: none;">
                    <div class="id-label">Your Customer ID</div>
                    <div class="id-value" id="customerId"></div>
                </div>

                <div class="info-panel">
                    <button type="button" class="btn btn-secondary" onclick="loadDemoIncomeData()" style="float: right; padding: 0.5rem 1rem;">
                        📋 Load Demo Data
                    </button>
                    <h4>Income Eligibility Assessment</h4>
                    <p>This information helps us determine which energy assistance programs you qualify for. All information is confidential.</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                        Results are estimates only. Contact program administrators for official eligibility determination.<br>
                        <strong>Using 2025 Data:</strong> HUD Income Limits, HHS Poverty Guidelines | Last verified: Oct 29, 2025
                    </p>
                    <div style="clear: both;"></div>
                </div>

                <form id="incomeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="householdSize">Household Size *</label>
                            <select id="householdSize" class="form-control" required>
                                <option value="1">1 person</option>
                                <option value="2">2 people</option>
                                <option value="3">3 people</option>
                                <option value="4">4 people</option>
                                <option value="5">5 people</option>
                                <option value="6">6 people</option>
                                <option value="7">7 people</option>
                                <option value="8">8 people</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="income">Household Income *</label>
                            <input type="number" id="income" class="form-control" min="0" step="100" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label for="frequency">Income Frequency *</label>
                            <select id="frequency" class="form-control" required>
                                <option value="annual">Annual</option>
                                <option value="monthly">Monthly</option>
                                <option value="biweekly">Biweekly</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tax Status *</label>
                            <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="taxStatus" value="pretax" checked>
                                    <span>Pre-tax (Gross)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="taxStatus" value="posttax">
                                    <span>Post-tax (Net)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ← Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="calculateIncome()">
                            Calculate Eligibility
                        </button>
                    </div>
                </form>

                <div id="incomeResults" style="display: none;">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Your Eligibility Results</h3>
                    
                    <div class="summary-grid" id="incomeSummary"></div>
                    
                    <div id="programEligibility"></div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ← Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                            Continue to Energy Assessment →
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODULE 3: Energy Assessment -->
            <div class="module" id="module3">
                <h2 class="module-title">Step 3: Home Energy Assessment</h2>
                
                <div class="info-panel">
                    <button type="button" class="btn btn-secondary" onclick="loadDemoAssessmentData()" style="float: right; padding: 0.5rem 1rem;">
                        📋 Load Demo Data
                    </button>
                    <h4>Comprehensive Home Energy Evaluation</h4>
                    <p>Provide details about your home's current condition and systems. Use "N/A" for unknown items.</p>
                    <div style="clear: both;"></div>
                </div>

                <form id="assessmentForm">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Property Details</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="homeSquareFootage">Home Square Footage</label>
                            <input type="number" id="homeSquareFootage" class="form-control" placeholder="e.g., 2000">
                        </div>
                        <div class="form-group">
                            <label for="conditionedSpace">Conditioned Space (for HVAC sizing)</label>
                            <input type="number" id="conditionedSpace" class="form-control" placeholder="e.g., 1800">
                        </div>
                        <div class="form-group">
                            <label for="homeAge">Home Age / Year Built</label>
                            <input type="number" id="homeAge" class="form-control" placeholder="e.g., 1975 or 50 years" min="1800" max="2025">
                        </div>
                        <div class="form-group">
                            <label for="foundationType">Foundation Type</label>
                            <select id="foundationType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="slab">Slab</option>
                                <option value="crawlspace">Crawlspace</option>
                                <option value="basement_unfinished">Basement - Unfinished</option>
                                <option value="basement_finished">Basement - Finished</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="roofCondition">Roof Condition</label>
                            <select id="roofCondition" class="form-control">
                                <option value="na">N/A</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Building Envelope</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="atticInsulation">Attic Insulation</label>
                            <select id="atticInsulation" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">None</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wallInsulation">Wall Insulation</label>
                            <select id="wallInsulation" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">None</option>
                                <option value="partial">Partial</option>
                                <option value="full">Full</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="floorInsulation">Floor/Crawlspace/Basement Insulation</label>
                            <select id="floorInsulation" class="form-control">
                                <option value="na">N/A (slab foundation)</option>
                                <option value="none">None</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                                <option value="excellent">Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="windowType">Window Type</label>
                            <select id="windowType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="single">Single Pane</option>
                                <option value="double">Double Pane</option>
                                <option value="triple">Triple Pane</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="doorSealing">Door Sealing</label>
                            <select id="doorSealing" class="form-control">
                                <option value="na">N/A</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">HVAC Systems</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="heatingType">Primary Heating System</label>
                            <select id="heatingType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="gas_furnace">Gas Furnace</option>
                                <option value="electric_furnace">Electric Furnace</option>
                                <option value="heat_pump">Heat Pump</option>
                                <option value="baseboard">Electric Baseboard</option>
                                <option value="wood_stove">Wood Stove</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="heatingAge">Heating System Age (years)</label>
                            <input type="number" id="heatingAge" class="form-control" min="0" placeholder="Years">
                        </div>
                        <div class="form-group">
                            <label for="coolingType">Cooling System</label>
                            <select id="coolingType" class="form-control">
                                <option value="none">None</option>
                                <option value="central_ac">Central AC</option>
                                <option value="heat_pump">Heat Pump</option>
                                <option value="window_units">Window Units</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ductwork">Ductwork Condition</label>
                            <select id="ductwork" class="form-control">
                                <option value="na">N/A</option>
                                <option value="none">No Ducts</option>
                                <option value="poor">Poor</option>
                                <option value="fair">Fair</option>
                                <option value="good">Good</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Water Heating</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="waterHeaterType">Water Heater Type</label>
                            <select id="waterHeaterType" class="form-control">
                                <option value="na">N/A</option>
                                <option value="gas_tank">Gas Tank</option>
                                <option value="electric_tank">Electric Tank</option>
                                <option value="heat_pump_water_heater">Heat Pump Water Heater</option>
                                <option value="tankless_gas">Tankless Gas</option>
                                <option value="tankless_electric">Tankless Electric</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="waterHeaterAge">Water Heater Age (years)</label>
                            <input type="number" id="waterHeaterAge" class="form-control" min="0" placeholder="Years">
                        </div>
                        <div class="form-group">
                            <label for="waterHeaterLocation">Water Heater Location</label>
                            <select id="waterHeaterLocation" class="form-control">
                                <option value="na">N/A</option>
                                <option value="garage">Garage</option>
                                <option value="basement">Basement</option>
                                <option value="utility_room">Utility Room</option>
                                <option value="closet">Closet (Conditioned Space)</option>
                                <option value="exterior">Exterior</option>
                            </select>
                        </div>
                    </div>

                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Health & Safety</h3>
                    
                    <div class="form-group">
                        <label>Check all that apply:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="combustion">
                                <span>Combustion Appliances Present</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="moisture">
                                <span>Moisture/Water Issues</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="mold">
                                <span>Visible Mold</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="asbestos">
                                <span>Suspected Asbestos</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="lead">
                                <span>Suspected Lead Paint</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="healthSafety" value="none">
                                <span>No Known Health/Safety Issues</span>
                            </label>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            ← Back
                        </button>
                        <button type="button" class="btn btn-primary" onclick="analyzeAssessment()">
                            Analyze Home Assessment
                        </button>
                    </div>
                </form>

                <div id="assessmentResults" style="display: none;">
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Assessment Summary</h3>
                    
                    <div class="summary-grid" id="assessmentSummary"></div>
                    
                    <div id="assessmentRecommendations"></div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="editAssessment()">
                            ← Edit Assessment
                        </button>
                        <button type="button" class="btn btn-primary" onclick="proceedToResults()">
                            View Personalized Incentives →
                        </button>
                    </div>
                </div>
            </div>

            <!-- MODULE 4: Incentive Insights & Pathways -->
            <div class="module" id="module4">
                <h2 class="module-title">Step 4: Personalized Incentive Pathways</h2>
                
                <div class="info-panel">
                    <h4>Your Customized Retrofit Plan</h4>
                    <p>Based on your intake profile, income eligibility, and home assessment, here are your personalized recommendations with available incentives and financing options.</p>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; font-style: italic;">
                        <strong>Disclaimer:</strong> This tool is not affiliated with Energy Trust of Oregon, Oregon Housing & Community Services, or Oregon Department of Energy. 
                        Incentive amounts and eligibility are estimates—applications must be submitted through official program channels for verification and approval.
                    </p>
                </div>

                <div id="comprehensiveResults">
                    <div class="alert alert-info">
                        <strong>📋 Complete all previous steps to see your personalized incentive pathways.</strong>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">
                        ← Back to Assessment
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadReport()">
                        📥 Download Full Report
                    </button>
                    <button type="button" class="btn btn-primary" onclick="startOver()">
                        🔄 Start New Assessment
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer Disclaimer -->
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 1.5rem; margin-top: 2rem; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);">
            <h3 style="color: var(--brand); font-size: 1.1rem; margin-bottom: 0.75rem;">📄 Important Disclaimer</h3>
            <p style="font-size: 0.9rem; color: #666; line-height: 1.6; margin: 0;">
                This Oregon Comprehensive Energy Assessment tool is an <strong>independent resource</strong> provided for informational and educational purposes only. 
                It is <strong>not affiliated with, endorsed by, or officially connected to</strong> Energy Trust of Oregon, Oregon Housing & Community Services (OHCS), 
                Oregon Department of Energy (ODOE), or any federal, state, or local energy assistance program.
            </p>
            <p style="font-size: 0.9rem; color: #666; line-height: 1.6; margin: 0.75rem 0 0 0;">
                <strong>All eligibility determinations, incentive amounts, and program access must be confirmed directly with official program administrators.</strong> 
                Estimates provided by this tool are based on 2025 program guidelines but are subject to change based on program availability, funding levels, and individual circumstances. 
                To apply for programs or verify eligibility, please contact the respective program administrators using the contact information provided in your assessment results.
            </p>
            <p style="font-size: 0.85rem; color: #888; margin: 0.75rem 0 0 0; font-style: italic;">
                <strong>Data Sources:</strong> 2025 HUD Income Limits, Federal Poverty Guidelines, Energy Trust program guidelines, and publicly available program documentation.<br>
                <strong>Last Verified:</strong> October 29, 2025 | <strong>Data Version:</strong> 1.0 | <strong>Next Review:</strong> December 2025<br>
                Use at your own discretion. Verify all amounts with official program administrators.
            </p>
        </div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        const appState = {
            currentStep: 1,
            customerData: {},
            incomeData: {},
            assessmentData: {},
            eligibilityResults: {},
            recommendations: []
        };
        
        // Income data loader instance
        const incomeDataLoader = new IncomeDataLoader();

        // ===== OREGON DATA (2025 OFFICIAL) =====
        // All data sourced from official government agencies - see docs/DATA_SOURCES.md
        // Last verified: October 2025
        
        // 2025 Area Median Income (AMI) by County
        // Source: HUD Income Limits 2025 | oregon-income-calculator repo
        // Reference: https://www.huduser.gov/portal/datasets/il.html
        // Used for: Energy Trust, CPF, HEAR, HOMES eligibility
        const oregonCounties = {
            "Baker County": { ami: 55800 },
            "Benton County": { ami: 76900 },
            "Clackamas County": { ami: 95800 },
            "Clatsop County": { ami: 67500 },
            "Columbia County": { ami: 82100 },
            "Coos County": { ami: 61400 },
            "Crook County": { ami: 61900 },
            "Curry County": { ami: 56200 },
            "Deschutes County": { ami: 81300 },
            "Douglas County": { ami: 63200 },
            "Gilliam County": { ami: 58400 },
            "Grant County": { ami: 52100 },
            "Harney County": { ami: 53900 },
            "Hood River County": { ami: 79400 },
            "Jackson County": { ami: 68900 },
            "Jefferson County": { ami: 59700 },
            "Josephine County": { ami: 58700 },
            "Klamath County": { ami: 58900 },
            "Lake County": { ami: 54700 },
            "Lane County": { ami: 72100 },
            "Lincoln County": { ami: 64700 },
            "Linn County": { ami: 69200 },
            "Malheur County": { ami: 51200 },
            "Marion County": { ami: 78400 },
            "Morrow County": { ami: 67800 },
            "Multnomah County": { ami: 95800 },
            "Polk County": { ami: 73800 },
            "Sherman County": { ami: 59100 },
            "Tillamook County": { ami: 67300 },
            "Umatilla County": { ami: 62800 },
            "Union County": { ami: 57600 },
            "Wallowa County": { ami: 54300 },
            "Wasco County": { ami: 65100 },
            "Washington County": { ami: 98200 },
            "Wheeler County": { ami: 50800 },
            "Yamhill County": { ami: 75600 }
        };

        // 2025 Federal Poverty Guidelines (HHS)
        // Source: U.S. Department of Health & Human Services
        // Reference: https://aspe.hhs.gov/poverty-guidelines
        // Used for: LIHEAP, Weatherization eligibility determination
        const fplData = {
            1: 15060, 2: 20440, 3: 25820, 4: 31200,
            5: 36580, 6: 41960, 7: 47340, 8: 52720
        };

        // 2025 Household size adjustments for AMI/SMI
        // Source: HUD Income Limits methodology
        // Adjusts county/state median incomes for household size
        // 4-person household = 1.00 (base), others scaled accordingly
        const householdAdjustments = {
            1: 0.70, 2: 0.80, 3: 0.90, 4: 1.00,
            5: 1.08, 6: 1.16, 7: 1.24, 8: 1.32
        };

        // 2025 Oregon State Median Income (4-person household)
        // Source: Oregon OHCS 2025
        // Used for: Weatherization eligibility (uses SMI, not AMI)
        // IMPORTANT: Weatherization uses SMI ≤60%, NOT AMI
        const oregonSMI = 78600;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Load income data first
            const loaded = await incomeDataLoader.loadData();
            if (!loaded) {
                console.error('Failed to load income data - falling back to legacy calculation');
            } else {
                console.log('✅ Income data loaded successfully');
            }
            
            populateCounties();
            initializeApp();
            initializeDragAndDrop();
        });

        function populateCounties() {
            const countySelect = document.getElementById('county');
            Object.keys(oregonCounties).sort().forEach(county => {
                const option = document.createElement('option');
                option.value = county;
                option.textContent = county;
                countySelect.appendChild(option);
            });
        }

        function initializeApp() {
            updateProgress();
        }

        // ===== NAVIGATION =====
        function goToStep(step) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(module => {
                module.classList.remove('active');
            });
            
            // Show target module
            document.getElementById(`module${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else {
                    stepEl.classList.remove('completed');
                }
            });
            document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
            
            appState.currentStep = step;
            updateProgress();
            
            // Auto-load demo data if in quick demo mode
            if (isQuickDemoMode) {
                setTimeout(() => {
                    if (step === 2) {
                        loadDemoIncomeData(true);
                    } else if (step === 3) {
                        loadDemoAssessmentData(true);
                    }
                }, 100);
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgress() {
            const progress = ((appState.currentStep - 1) / 3) * 100;
            document.getElementById('progressLine').style.width = `${progress}%`;
        }

        // ===== MODULE 1: CUSTOMER INTAKE =====
        function submitIntake() {
            const form = document.getElementById('intakeForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Validate at least one electric utility is selected
            const electricUtilities = Array.from(document.querySelectorAll('input[name="utilityElectric"]:checked')).map(cb => cb.value);
            const gasUtilities = Array.from(document.querySelectorAll('input[name="utilityGas"]:checked')).map(cb => cb.value);
            
            if (electricUtilities.length === 0) {
                alert('Please select at least one electric utility provider.');
                return;
            }

            // Gather customer data
            const prioritizedConcerns = getPrioritizedConcerns();
            const priorityCommunities = Array.from(document.querySelectorAll('input[name="priorityCommunity"]:checked')).map(cb => cb.value);
            const workingWithCBO = document.getElementById('workingWithCBO').value === 'yes';
            const cboName = workingWithCBO ? document.getElementById('cboName').value : null;
            const optOutFederalPrograms = document.getElementById('optOutFederalPrograms').checked;
            
            appState.customerData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                county: document.getElementById('county').value,
                electricUtilities: electricUtilities,
                gasUtilities: gasUtilities,
                allUtilities: [...electricUtilities, ...gasUtilities],
                housingType: document.getElementById('housingType').value,
                ownershipStatus: document.getElementById('ownershipStatus').value,
                prioritizedConcerns: prioritizedConcerns,
                concerns: prioritizedConcerns.map(c => c.id), // Legacy format for compatibility
                urgency: document.getElementById('urgency').value,
                priorityCommunities: priorityCommunities,
                workingWithCBO: workingWithCBO,
                cboName: cboName,
                optOutFederalPrograms: optOutFederalPrograms,
                timestamp: new Date().toISOString()
            };

            // Generate customer ID
            appState.customerData.customerId = generateCustomerId();
            
            // Show customer ID in next module
            document.getElementById('customerId').textContent = appState.customerData.customerId;
            document.getElementById('customerIdDisplay').style.display = 'block';

            // Pre-fill county in income module
            const countyFromIntake = document.getElementById('county').value;
            
            goToStep(2);
        }

        function generateCustomerId() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 7);
            return `OR-${timestamp}-${random}`.toUpperCase();
        }
        
        function toggleCBODetails() {
            const workingWithCBO = document.getElementById('workingWithCBO').value === 'yes';
            const cboDetailsGroup = document.getElementById('cboDetailsGroup');
            cboDetailsGroup.style.display = workingWithCBO ? 'block' : 'none';
            if (!workingWithCBO) {
                document.getElementById('cboName').value = '';
            }
        }

        // ===== MODULE 2: INCOME QUALIFICATION =====
        function calculateIncome() {
            const form = document.getElementById('incomeForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const income = parseFloat(document.getElementById('income').value);
            const frequency = document.getElementById('frequency').value;
            const taxStatus = document.querySelector('input[name="taxStatus"]:checked').value;
            const householdSize = parseInt(document.getElementById('householdSize').value);
            const county = appState.customerData.county;

            // Convert to annual income
            const annualIncome = convertToAnnual(income, frequency, taxStatus);

            // Calculate percentages
            const percentages = calculatePercentages(annualIncome, county, householdSize);

            // Store income data
            appState.incomeData = {
                householdSize,
                annualIncome,
                percentages,
                county
            };

            // Determine eligibility with priority community consideration
            const isPriorityCommunity = appState.customerData.priorityCommunities && appState.customerData.priorityCommunities.length > 0;
            const workingWithCBO = appState.customerData.workingWithCBO;
            const optOutFederal = appState.customerData.optOutFederalPrograms || false;
            
            appState.eligibilityResults = {
                // Core income-based programs (LIHEAP is federal but not part of opt-out - it's bill assistance)
                liheap: !optOutFederal && percentages.fpl <= 150,
                
                // Weatherization uses ≤60% SMI (not AMI) or ≤200% FPL - FILTERED if opt-out
                // Source: DATA_SOURCES.md line 178 | OHCS WAP 2025 guidelines
                weatherization: !optOutFederal && (percentages.smi <= 60 || percentages.fpl <= 200),
                
                // CPF eligibility rules (Energy Trust CPF program)
                // Tier 1: ≤80% AMI + (priority community OR CBO)
                // Tier 2: 81-150% AMI + (priority community AND CBO) - requires both
                // Source: DATA_SOURCES.md line 179 | Energy Trust CPF program rules
                // Note: >80% AMI tier NOT eligible for federal HEAR/HOMES unless opting out
                cpfEligible: !optOutFederal && (
                    (percentages.ami <= 80 && (isPriorityCommunity || workingWithCBO)) ||
                    (percentages.ami > 80 && percentages.ami <= 150 && isPriorityCommunity && workingWithCBO)
                ),
                
                // Standard income-qualified (Energy Trust is utility/state-funded, NOT federal)
                energyTrust: percentages.ami <= 80,
                lowIncomeHousing: percentages.ami <= 80,
                firstTimeHomebuyer: percentages.ami <= 120,
                
                // HEAR eligibility - Federal IRA program - FILTERED if opt-out
                // ≤80% AMI: Eligible for HEAR 100%
                // 81-150% AMI: Eligible ONLY if NOT in CPF Tier 2 (priority+CBO)
                // Source: IRA Section 50122, incentive_eligibility_map.json line 43
                // Note: CPF Tier 2 (81-150% AMI) customers choose CPF OR federal, not both
                hearLowIncome: !optOutFederal && percentages.ami <= 80,    // 100% HEAR (all ≤80% AMI)
                hearModerate: !optOutFederal && percentages.ami > 80 && percentages.ami <= 150 && 
                    !(isPriorityCommunity && workingWithCBO),  // NOT available if in CPF Tier 2
                hearWeatherization: !optOutFederal && (percentages.smi <= 60 || percentages.fpl <= 200),
                
                // HOMES eligibility - Federal IRA program - FILTERED if opt-out
                // Up to 400% AMI EXCEPT CPF Tier 2 customers (81-150% with priority+CBO)
                homesEligible: !optOutFederal && percentages.ami <= 400 && 
                    !(percentages.ami > 80 && percentages.ami <= 150 && isPriorityCommunity && workingWithCBO),
                homesWeatherization: !optOutFederal && (percentages.smi <= 60 || percentages.fpl <= 200),
                
                // Market rate
                standardPrograms: percentages.ami > 150,
                
                // Priority flags
                isPriorityCommunity: isPriorityCommunity,
                workingWithCBO: workingWithCBO,
                optOutFederalPrograms: optOutFederal
            };

            // Display results
            displayIncomeResults(annualIncome, percentages, householdSize);
        }
        function convertToAnnual(amount, frequency, taxStatus) {
            let annualAmount = amount;
            
            switch(frequency) {
                case 'monthly': annualAmount = amount * 12; break;
                case 'biweekly': annualAmount = amount * 26; break;
                case 'weekly': annualAmount = amount * 52; break;
            }
            
            if (taxStatus === 'posttax') {
                annualAmount = annualAmount * 1.25;
            }
            
            return Math.round(annualAmount);
        }

        function calculatePercentages(annualIncome, county, householdSize) {
            // Try to use new income data loader first (exact values)
            if (incomeDataLoader.isLoaded()) {
                const result = incomeDataLoader.calculatePercentages(annualIncome, county, householdSize);
                if (result) {
                    console.log('✅ Using exact income thresholds from JSON file');
                    return result;
                }
            }
            
            // Fallback to legacy calculation method
            console.warn('⚠️ Falling back to legacy income calculation');
            const countyAMI = oregonCounties[county].ami;
            const adjustment = householdAdjustments[householdSize];
            const adjustedAMI = countyAMI * adjustment;
            const adjustedSMI = oregonSMI * adjustment;
            const fplAmount = fplData[householdSize];
            
            return {
                ami: Math.round((annualIncome / adjustedAMI) * 100),
                smi: Math.round((annualIncome / adjustedSMI) * 100),
                fpl: Math.round((annualIncome / fplAmount) * 100),
                adjustedAMI,
                adjustedSMI,
                fplAmount
            };
        }

        function displayIncomeResults(annualIncome, percentages, householdSize) {
            const summaryHTML = `
                <div class="summary-card ${percentages.ami <= 80 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.ami}%</div>
                    <div class="summary-label">Area Median Income</div>
                </div>
                <div class="summary-card ${percentages.smi <= 60 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.smi}%</div>
                    <div class="summary-label">State Median Income</div>
                </div>
                <div class="summary-card ${percentages.fpl <= 150 ? 'highlight' : ''}">
                    <div class="summary-value">${percentages.fpl}%</div>
                    <div class="summary-label">Federal Poverty Level</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">$${annualIncome.toLocaleString()}</div>
                    <div class="summary-label">Annual Income</div>
                </div>
            `;
            
            document.getElementById('incomeSummary').innerHTML = summaryHTML;

            const eligibility = appState.eligibilityResults;
            
            let priorityBadges = '';
            if (eligibility.isPriorityCommunity) {
                const communities = appState.customerData.priorityCommunities.map(c => c.replace(/_/g, ' ')).join(', ');
                priorityBadges += `<span class="badge badge-warning">⭐ Priority Community: ${communities}</span>`;
            }
            if (eligibility.workingWithCBO && appState.customerData.cboName) {
                priorityBadges += `<span class="badge badge-info">🤝 CBO Partner: ${appState.customerData.cboName}</span>`;
            }
            
            // Show opt-out notification if applicable
            const optOutNotice = eligibility.optOutFederalPrograms ? `
                <div style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                    <strong>🚫 Federal Program Opt-Out Active</strong><br>
                    <span style="font-size: 0.9rem;">You have chosen to opt out of federally-funded programs (CPF, OHCS Weatherization, HEAR, HOMES). Only state and utility-funded programs will be shown.</span>
                </div>
            ` : '';
            
            const programHTML = `
                <div class="info-panel">
                    <h4>Program Eligibility Summary</h4>
                    ${optOutNotice}
                    ${priorityBadges ? `<div style="margin: 1rem 0; padding: 1rem; background: #fff3cd; border-radius: 8px;"><strong>Priority Status:</strong><br>${priorityBadges}</div>` : ''}
                    <div style="margin-top: 1rem;">
                        ${eligibility.weatherization ? '<span class="badge badge-success">✓ Oregon Weatherization (NO COST - ≤60% SMI or ≤200% FPL) ⚠️ Check waitlist</span>' : ''}
                        ${eligibility.cpfEligible ? '<span class="badge badge-success">✓ Community Partner Fund (CPF) - Enhanced Incentives</span>' : ''}
                        ${eligibility.liheap ? '<span class="badge badge-success">✓ LIHEAP Bill Assistance (≤150% FPL)</span>' : ''}
                        ${eligibility.energyTrust ? '<span class="badge badge-success">✓ Energy Trust Income-Qualified (≤80% AMI)</span>' : ''}
                        ${(eligibility.hearLowIncome || eligibility.hearModerate || eligibility.hearWeatherization) ? '<span class="badge badge-success">✓ HEAR (IRA Federal) - All income tiers eligible</span>' : ''}
                        ${eligibility.homesEligible ? '<span class="badge badge-success">✓ HOMES Whole-Home Rebate (IRA Federal) - All income tiers eligible</span>' : ''}
                        ${eligibility.standardPrograms ? '<span class="badge badge-info">Standard Energy Trust Programs Available</span>' : ''}
                    </div>
                    ${eligibility.weatherization ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                            <strong>⚠️ Important:</strong> Oregon Weatherization may have waitlists. Check agency capacity. 
                            Meanwhile, you can also access ${eligibility.workingWithCBO ? 'CPF (via CBO), ' : ''}HOMES/HEAR programs for faster upgrades.
                        </div>
                    ` : ''}
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                        <strong>Your Eligibility Tier:</strong> 
                        ${eligibility.weatherization ? '<span style="color: #155724; font-size: 1.1rem;">🎉 NO-COST WEATHERIZATION (+ HOMES/HEAR available)</span>' : 
                          eligibility.cpfEligible ? '<span style="color: #155724; font-size: 1.1rem;">⭐ ENHANCED INCENTIVES (CPF + HOMES/HEAR)</span>' : 
                          eligibility.hearModerate ? '<span style="color: #0c5460; font-size: 1.1rem;">💰 MODERATE INCOME (Standard + HEAR/HOMES)</span>' :
                          '<span style="color: #0c5460; font-size: 1.1rem;">📊 STANDARD PROGRAMS</span>'}
                    </div>
                </div>
            `;
            
            document.getElementById('programEligibility').innerHTML = programHTML;
            
            document.getElementById('incomeForm').style.display = 'none';
            document.getElementById('incomeResults').style.display = 'block';
        }

        // ===== MODULE 3: ENERGY ASSESSMENT =====
        function analyzeAssessment() {
            // Gather assessment data
            appState.assessmentData = {
                homeSquareFootage: document.getElementById('homeSquareFootage').value,
                conditionedSpace: document.getElementById('conditionedSpace').value,
                homeAge: document.getElementById('homeAge').value,
                foundationType: document.getElementById('foundationType').value,
                roofCondition: document.getElementById('roofCondition').value,
                atticInsulation: document.getElementById('atticInsulation').value,
                wallInsulation: document.getElementById('wallInsulation').value,
                floorInsulation: document.getElementById('floorInsulation').value,
                windowType: document.getElementById('windowType').value,
                doorSealing: document.getElementById('doorSealing').value,
                heatingType: document.getElementById('heatingType').value,
                heatingAge: document.getElementById('heatingAge').value,
                coolingType: document.getElementById('coolingType').value,
                ductwork: document.getElementById('ductwork').value,
                waterHeaterType: document.getElementById('waterHeaterType').value,
                waterHeaterAge: document.getElementById('waterHeaterAge').value,
                waterHeaterLocation: document.getElementById('waterHeaterLocation').value,
                healthSafety: Array.from(document.querySelectorAll('input[name="healthSafety"]:checked')).map(cb => cb.value)
            };

            // Analyze and generate recommendations
            generateRecommendations();
            
            // Display assessment summary
            displayAssessmentSummary();
            
            document.getElementById('assessmentForm').style.display = 'none';
            document.getElementById('assessmentResults').style.display = 'block';
        }

        function generateRecommendations() {
            const data = appState.assessmentData;
            const recommendations = [];
            let priority = 1;

            // Health & Safety first - Calculate cost based on issues
            if (data.healthSafety.length > 0 && !data.healthSafety.includes('none')) {
                // Cost estimates per issue type
                const issueCosts = {
                    'combustion': 1500,  // CO monitor + venting inspection
                    'moisture': 2500,    // Moisture remediation
                    'mold': 3500,        // Mold remediation
                    'asbestos': 5000,    // Asbestos testing/abatement
                    'lead': 4000         // Lead testing/containment
                };
                
                let totalCost = 500; // Base assessment cost
                data.healthSafety.forEach(issue => {
                    if (issueCosts[issue]) {
                        totalCost += issueCosts[issue];
                    }
                });
                
                const issueDescriptions = data.healthSafety.map(issue => {
                    const names = {
                        'combustion': 'combustion appliances',
                        'moisture': 'moisture/water issues',
                        'mold': 'mold remediation',
                        'asbestos': 'asbestos',
                        'lead': 'lead paint'
                    };
                    return names[issue] || issue;
                }).join(', ');
                
                recommendations.push({
                    priority: '🔴',
                    measure: 'Health & Safety Assessment and Repairs',
                    description: `Address ${issueDescriptions} before proceeding with other upgrades`,
                    estimatedCost: `$${totalCost.toLocaleString()}`,
                    incentive: 'Calculated based on eligibility',
                    dependencies: 'Required before weatherization work',
                    healthSafetyIssues: data.healthSafety
                });
            }

            // Insulation recommendations (using residential insights data: $1.0-4.5/sqft)
            if (data.atticInsulation === 'none' || data.atticInsulation === 'poor') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const costPerSqft = data.atticInsulation === 'none' ? 3.0 : 2.5; // Higher for none
                const cost = Math.round(sqft * costPerSqft);
                const monthlySavings = Math.round((sqft / 1000) * 25); // ~$25/month per 1000 sqft
                recommendations.push({
                    priority: '🟠',
                    measure: 'Attic Insulation',
                    description: `Upgrade attic insulation to R-38+ (~${sqft.toLocaleString()} sq ft)`,
                    estimatedCost: `$${cost.toLocaleString()}`,
                    sqft: sqft, // Store for incentive calculation
                    monthlySavings: monthlySavings,
                    incentive: 'Calculated based on eligibility',
                    dependencies: 'Roof in good condition'
                });
            }

            if (data.wallInsulation === 'none' || data.wallInsulation === 'partial') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const wallSqft = Math.round(sqft * 0.6); // Exterior wall area approximation
                const costPerSqft = data.wallInsulation === 'none' ? 4.0 : 3.0; // $1.0-4.5/sqft range
                const cost = Math.round(wallSqft * costPerSqft);
                const monthlySavings = Math.round((sqft / 1000) * 20); // ~$20/month per 1000 sqft home
                recommendations.push({
                    priority: '🟠',
                    measure: 'Wall Insulation',
                    description: `Add wall insulation (~${wallSqft.toLocaleString()} sq ft)`,
                    estimatedCost: `$${cost.toLocaleString()}`,
                    sqft: wallSqft,
                    monthlySavings: monthlySavings,
                    incentive: 'Calculated based on eligibility',
                    dependencies: 'None'
                });
            }
            
            // Floor/Crawlspace insulation
            if ((data.foundationType === 'crawlspace' || data.foundationType === 'basement_unfinished') && 
                (data.floorInsulation === 'none' || data.floorInsulation === 'poor')) {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const costPerSqft = 3.5; // Mid-range for floor insulation
                const cost = Math.round(sqft * costPerSqft);
                const monthlySavings = Math.round((sqft / 1000) * 18); // ~$18/month per 1000 sqft
                recommendations.push({
                    priority: '🟠',
                    measure: 'Floor Insulation',
                    description: `Insulate floor/crawlspace to R-30 (~${sqft.toLocaleString()} sq ft)`,
                    estimatedCost: `$${cost.toLocaleString()}`,
                    sqft: sqft,
                    monthlySavings: monthlySavings,
                    incentive: 'Calculated based on eligibility',
                    dependencies: 'Moisture control may be required first'
                });
            }

            // HVAC recommendations - Differentiate ducted vs ductless based on existing ductwork
            const heatingAge = parseInt(data.heatingAge) || 0;
            if (heatingAge > 15 || data.heatingType === 'baseboard' || data.heatingType === 'electric_furnace') {
                const hasGoodDucts = data.ductwork === 'good' || data.ductwork === 'fair';
                const conditionedSpace = parseInt(data.conditionedSpace) || 1800;
                
                if (hasGoodDucts && (data.heatingType === 'electric_furnace' || data.heatingType === 'gas_furnace')) {
                    // Recommend ducted heat pump for homes with existing duct system
                    // Residential insights: $2500-15000 range for heat pumps
                    const cost = 12000; // Typical ducted system cost
                    // Heat pump savings: $75-150/month depending on replaced system
                    const monthlySavings = data.heatingType === 'electric_furnace' ? 120 : 80;
                    recommendations.push({
                        priority: '🟡',
                        measure: 'Heat Pump System',
                        heatPumpType: 'ducted',
                        description: `Install ducted (central) heat pump system (HSPF2 ≥7.5) to utilize existing ductwork`,
                        estimatedCost: `$${cost.toLocaleString()}`,
                        monthlySavings: monthlySavings,
                        incentive: 'Calculated based on eligibility',
                        dependencies: 'Duct sealing recommended first'
                    });
                } else {
                    // Recommend ductless for homes without ducts or with poor duct condition
                    const units = Math.ceil(conditionedSpace / 900);
                    const costPerUnit = units === 1 ? 6000 : 5000; // Single vs multi-head
                    const cost = units * costPerUnit;
                    const monthlySavings = data.heatingType === 'baseboard' ? 100 : 75;
                    recommendations.push({
                        priority: '🟡',
                        measure: 'Heat Pump System',
                        heatPumpType: 'ductless',
                        description: `Install ${units} ductless heat pump unit(s) (HSPF2 ≥8.1) - no ductwork needed`,
                        estimatedCost: `$${cost.toLocaleString()}`,
                        monthlySavings: monthlySavings,
                        incentive: 'Calculated based on eligibility',
                        dependencies: 'Insulation upgrades recommended first'
                    });
                }
            }

            // Windows
            if (data.windowType === 'single') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const monthlySavings = Math.round((sqft / 1000) * 15); // ~$15/month per 1000 sqft
                recommendations.push({
                    priority: '🟡',
                    measure: 'Window Upgrades',
                    description: 'Replace single-pane windows with double-pane Energy Star windows',
                    estimatedCost: '$5,000 - $15,000',
                    monthlySavings: monthlySavings,
                    incentive: 'Potential tax credits available',
                    dependencies: 'None'
                });
            }

            // Air sealing
            if (data.doorSealing === 'poor') {
                const sqft = parseInt(data.homeSquareFootage) || 2000;
                const monthlySavings = Math.round((sqft / 1000) * 12); // ~$12/month per 1000 sqft
                recommendations.push({
                    priority: '🟢',
                    measure: 'Air Sealing',
                    description: 'Professional air sealing and weatherstripping',
                    estimatedCost: '$500 - $2,000',
                    monthlySavings: monthlySavings,
                    incentive: 'May be included in weatherization program',
                    dependencies: 'Should be done with insulation work'
                });
            }
            
            // Heat Pump Water Heater
            // Residential insights: $3600-6500 cost, $240 standard incentive, $1750 HEAR
            const waterHeaterAge = parseInt(data.waterHeaterAge) || 0;
            if ((waterHeaterAge > 10 || data.waterHeaterType === 'electric_tank' || data.waterHeaterType === 'gas_tank') && 
                data.waterHeaterType !== 'heat_pump_water_heater') {
                const cost = 4500; // Mid-range for HPWH
                const monthlySavings = data.waterHeaterType === 'electric_tank' ? 35 : 25; // Higher savings from electric
                recommendations.push({
                    priority: '🟡',
                    measure: 'Heat Pump Water Heater',
                    description: 'Replace existing water heater with energy-efficient heat pump model (UEF ≥3.0)',
                    estimatedCost: `$${cost.toLocaleString()}`,
                    monthlySavings: monthlySavings,
                    incentive: 'Calculated based on eligibility',
                    dependencies: '30A dedicated circuit may be required'
                });
            }

            appState.recommendations = recommendations;
        }

        function displayAssessmentSummary() {
            const data = appState.assessmentData;
            const issues = countIssues(data);
            
            const summaryHTML = `
                <div class="summary-card">
                    <div class="summary-value">${appState.recommendations.length}</div>
                    <div class="summary-label">Recommendations</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${issues}</div>
                    <div class="summary-label">Potential Issues</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">${calculateTotalIncentives()}</div>
                    <div class="summary-label">Estimated Incentives</div>
                </div>
            `;
            
            document.getElementById('assessmentSummary').innerHTML = summaryHTML;

            if (appState.recommendations.length > 0) {
                let tableHTML = `
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Recommended Energy Upgrades</h3>
                    <table class="recommendations-table">
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Measure</th>
                                <th>Description</th>
                                <th>Est. Cost</th>
                                <th>Est. Monthly Savings</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                appState.recommendations.forEach(rec => {
                    const savingsDisplay = rec.monthlySavings ? `$${rec.monthlySavings}/month` : 'Varies';
                    tableHTML += `
                        <tr>
                            <td style="font-size: 1.5rem; text-align: center;">${rec.priority}</td>
                            <td><strong>${rec.measure}</strong></td>
                            <td>${rec.description}<br><small style="color: var(--muted);">${rec.dependencies}</small></td>
                            <td><strong>${rec.estimatedCost}</strong></td>
                            <td style="color: var(--success); font-weight: 600;">${savingsDisplay}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                document.getElementById('assessmentRecommendations').innerHTML = tableHTML;
            }
        }

        function countIssues(data) {
            let count = 0;
            if (data.atticInsulation === 'poor' || data.atticInsulation === 'none') count++;
            if (data.wallInsulation === 'none' || data.wallInsulation === 'partial') count++;
            if (data.windowType === 'single') count++;
            if (data.doorSealing === 'poor') count++;
            if (parseInt(data.heatingAge) > 15) count++;
            if (data.healthSafety.length > 0 && !data.healthSafety.includes('none')) count++;
            return count;
        }

        function calculateTotalIncentives() {
            let total = 0;
            appState.recommendations.forEach(rec => {
                const match = rec.incentive.match(/\$([0-9,]+)/);
                if (match) {
                    total += parseInt(match[1].replace(/,/g, ''));
                }
            });
            return `$${total.toLocaleString()}`;
        }

        function editAssessment() {
            document.getElementById('assessmentForm').style.display = 'block';
            document.getElementById('assessmentResults').style.display = 'none';
        }

        // ===== MODULE 4: COMPREHENSIVE INSIGHTS =====
        function showComprehensiveResults() {
            console.log('showComprehensiveResults called');
            console.log('Recommendations:', appState.recommendations);
            
            try {
                // Initialize IncentiveRules engine
                if (typeof IncentiveRules === 'undefined') {
                    console.error('IncentiveRules not loaded');
                    throw new Error('IncentiveRules not available');
                }
                
                const incentiveRules = new IncentiveRules();
                
                // Get customer eligibility tier
                const amiPercent = appState.incomeData.percentages.ami;
                const smiPercent = appState.incomeData.percentages.smi;
                const fplPercent = appState.incomeData.percentages.fpl;
                const eligibilityTier = incentiveRules.getEligibilityTier(amiPercent, smiPercent, fplPercent);
                
                console.log('Eligibility Tier:', eligibilityTier);
                
                // For weatherization-eligible, show CPF tier incentives
                const displayTier = eligibilityTier === 'weatherization' ? 'cpf_low' : eligibilityTier;
                
                console.log('Display Tier:', displayTier);
                
                // Build comprehensive results with tier info
                const tierDescription = incentiveRules.getTierDescription(eligibilityTier);
                
                // Calculate incentives for each recommended measure
                const eligibility = appState.eligibilityResults;
                const enrichedRecommendations = appState.recommendations.map(rec => {
                    // Map measure names to IDs
                    const measureId = mapMeasureToId(rec.measure, rec.heatPumpType);
                    
                    if (measureId) {
                        const measureDetails = {
                            housingType: appState.customerData.housingType,
                            sqft: rec.sqft || parseInt(appState.assessmentData.homeSquareFootage) || 2000,
                            cpfEligible: eligibility.cpfEligible || eligibility.weatherization
                        };
                        
                        const packages = incentiveRules.getIncentiveForMeasure(measureId, displayTier, measureDetails);
                        
                        // Parse estimated cost
                        const costMatch = rec.estimatedCost.match(/\$([0-9,]+)/);
                        const estimatedCost = costMatch ? parseInt(costMatch[1].replace(/,/g, '')) : 5000;
                        
                        // Get best package and calculate costs
                        const bestPackage = incentiveRules.getBestPackage(packages, estimatedCost);
                        const costCalc = incentiveRules.calculateNetCost(estimatedCost, bestPackage);
                        
                        return {
                            ...rec,
                            measureId: measureId,
                            packages: packages,
                            bestPackage: bestPackage,
                            totalIncentives: costCalc.totalIncentives,
                            netCost: costCalc.netCost,
                            coverage: costCalc.coverage,
                            estimatedCostNum: estimatedCost,
                            selected: true, // Default to selected
                            customerTier: eligibilityTier // Store for HOMES allocation
                        };
                    }
                    
                    return rec;
                });
                
                // Apply household-level caps (HEAR $14K, CERTA $2K)
                console.log('Applying household-level caps...');
                const cappedRecommendations = incentiveRules.applyHouseholdCaps(enrichedRecommendations);
                
                // Store enriched data
                appState.enrichedRecommendations = cappedRecommendations;
                appState.eligibilityTier = eligibilityTier;
                
                // Generate and display HTML
                console.log('Calling displayEnrichedResults');
                displayEnrichedResults(tierDescription, cappedRecommendations, eligibilityTier);
                console.log('displayEnrichedResults completed');
                
                // Apply no-cost enhancement if checkbox is checked by default
                setTimeout(() => {
                    const noCostCheckbox = document.getElementById('noCostEligible');
                    if (noCostCheckbox && noCostCheckbox.checked) {
                        console.log('Applying initial no-cost enhancement...');
                        applyNoCostEnhancement(true);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error generating comprehensive results:', error);
                alert('Error generating incentive details: ' + error.message + '. Please refresh and try again.');
                // Display error in results div
                document.getElementById('comprehensiveResults').innerHTML = `
                    <div class="alert" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem;">
                        <h4>Error Loading Incentive Details</h4>
                        <p>There was an error calculating your personalized incentives. Please refresh the page and try again.</p>
                        <p style="font-size: 0.9rem; color: #666;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function mapMeasureToId(measureName, heatPumpType) {
            // Handle heat pump differentiation
            if (measureName === 'Heat Pump System') {
                return heatPumpType === 'ducted' ? 'heat_pump_ducted' : 'heat_pump_ductless';
            }
            
            const mapping = {
                'Health & Safety Assessment and Repairs': 'health_safety_repairs',
                'Attic Insulation': 'attic_insulation',
                'Wall Insulation': 'wall_insulation',
                'Floor Insulation': 'floor_insulation',
                'Window Upgrades': 'window_replacement',
                'Air Sealing': 'air_sealing',
                'Duct Sealing': 'duct_sealing',
                'Heat Pump Water Heater': 'heat_pump_water_heater',
                'Smart Thermostat': 'smart_thermostat',
                'Electric Panel Upgrade': 'electric_panel_upgrade'
            };
            return mapping[measureName] || null;
        }
        
        function displayEnrichedResults(tierDescription, recommendations, eligibilityTier) {
            const customer = appState.customerData;
            const income = appState.incomeData;
            const eligibility = appState.eligibilityResults;
            
            let html = `
                <div class="customer-id-display">
                    <div class="id-label">Assessment ID</div>
                    <div class="id-value">${customer.customerId}</div>
                </div>

                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Your Personalized Energy Pathway</h3>
                
                <div class="alert alert-success">
                    <h4 style="margin-bottom: 0.5rem;">${tierDescription}</h4>
                    <p style="margin-bottom: 0.5rem;"><strong>Profile:</strong> ${customer.firstName} ${customer.lastName} | 
                    ${income.householdSize} person household | ${customer.county}</p>
                    <p style="margin: 0; font-size: 0.95rem;">
                        <strong>Income Qualification:</strong> 
                        ${income.percentages.ami}% AMI • 
                        ${income.percentages.smi}% SMI • 
                        ${income.percentages.fpl}% FPL
                    </p>
                </div>
            `;
            
            // Priority community status
            if (eligibility.isPriorityCommunity || eligibility.workingWithCBO) {
                html += `
                    <div class="info-panel" style="background: #fff3cd; border-left-color: #ffc107;">
                        <h4>⭐ Priority Community Benefits</h4>
                        <p>You qualify for enhanced programs:</p>
                        <ul style="margin-left: 1.5rem; line-height: 1.8;">
                            ${eligibility.cpfEligible ? '<li><strong>Community Partner Fund (CPF)</strong> - Higher rebates for all measures</li>' : ''}
                            ${eligibility.hearLowIncome ? '<li><strong>HEAR 100%</strong> - Full federal rebates on electrification</li>' : ''}
                            ${eligibility.hearModerate ? '<li><strong>HEAR 50%</strong> - Federal rebates on electrification</li>' : ''}
                            ${eligibility.workingWithCBO && customer.cboName ? `<li><strong>CBO Partnership</strong> - Working with ${customer.cboName}</li>` : ''}
                        </ul>
                        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.6); border-radius: 8px; font-size: 0.9rem;">
                            <strong>💡 Funding Strategy:</strong> Federal HEAR/HOMES incentives are applied first, then CPF fills remaining gaps.
                            CPF amounts may exceed remaining costs to ensure no-cost upgrades.
                        </div>
                    </div>
                `;
            }
            
            // Recommendations table with selection checkboxes
            if (recommendations.length > 0) {
                html += `
                    <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Prioritized Retrofit Plan with Your Incentives</h3>
                    
                    <!-- Program Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <!-- HOMES Opt-Out Option -->
                        <div style="padding: 1.25rem; background: #fff8e1; border: 2px solid #ffc107; border-radius: 10px;">
                            <label class="checkbox-label" style="background: transparent; padding: 0; cursor: pointer; display: flex; align-items: flex-start; gap: 1rem;">
                                <input type="checkbox" id="optOutHOMES" onchange="toggleHOMESOptOut()" 
                                       style="width: 22px; height: 22px; margin-top: 2px; accent-color: var(--brand); cursor: pointer; flex-shrink: 0;">
                                <div>
                                    <span style="font-weight: 600; font-size: 1rem; display: block; margin-bottom: 0.5rem;">
                                        📊 Opt out of HOMES
                                    </span>
                                    <p style="margin: 0; color: #856404; font-size: 0.9rem; line-height: 1.5;">
                                        HOMES requires energy audit. Uncheck to exclude if audit not available.
                                    </p>
                                </div>
                            </label>
                        </div>
                        
                        <!-- No-Cost Eligible Option -->
                        <div style="padding: 1.25rem; background: #d4edda; border: 2px solid #28a745; border-radius: 10px;">
                            <label class="checkbox-label" style="background: transparent; padding: 0; cursor: pointer; display: flex; align-items: flex-start; gap: 1rem;">
                                <input type="checkbox" id="noCostEligible" onchange="toggleNoCostEligible()" checked
                                       style="width: 22px; height: 22px; margin-top: 2px; accent-color: var(--success); cursor: pointer; flex-shrink: 0;">
                                <div>
                                    <span style="font-weight: 600; font-size: 1rem; display: block; margin-bottom: 0.5rem;">
                                        🌟 No-Cost Eligible
                                    </span>
                                    <p style="margin: 0; color: #155724; font-size: 0.9rem; line-height: 1.5;">
                                        Apply enhanced CPF/SWR no-cost incentives to insulation, heat pumps, and heat pump water heaters.
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; border: none; margin-bottom: 1.5rem;">
                        <h4 style="color: white; margin-bottom: 0.75rem; font-size: 1.2rem;">✅ SELECT YOUR PRIORITY MEASURES</h4>
                        <p style="margin: 0; font-size: 1.05rem; line-height: 1.6;">
                            <strong>Use the checkboxes below to select which measures you want to prioritize.</strong> 
                            The cost summary will automatically update to show:
                        </p>
                        <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
                            <li><strong>Selected Measures</strong> - Your chosen priority upgrades with total costs</li>
                            <li><strong>Full Scope</strong> - All recommended measures for comparison</li>
                        </ul>
                    </div>
                    <table class="recommendations-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Select</th>
                                <th>Priority</th>
                                <th>Measure</th>
                                <th>Est. Cost</th>
                                <th>Best Package</th>
                                <th>Coverage</th>
                                <th>Net Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                recommendations.forEach((rec, idx) => {
                    let packageDetails = '';
                    
                    if (rec.bestPackage && rec.bestPackage.incentives) {
                        packageDetails = `<strong>${rec.bestPackage.name}</strong><br>`;
                        packageDetails += rec.bestPackage.incentives
                            .filter(inc => typeof inc.amount === 'number' ? inc.amount > 0 : true) // Filter out zero amounts
                            .map(inc => {
                                const amount = typeof inc.amount === 'number' ? `$${inc.amount.toLocaleString()}` : inc.amount;
                                return `<div style="margin: 0.25rem 0; font-size: 0.85rem;">${inc.program}: ${amount}</div>`;
                            }).join('');
                        
                        if (rec.bestPackage.note) {
                            packageDetails += `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--muted); font-style: italic;">${rec.bestPackage.note}</div>`;
                        }
                        
                        // Show alternative packages if available
                        if (rec.packages && rec.packages.length > 1) {
                            packageDetails += `<button onclick="showPackageOptions(${idx})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">View ${rec.packages.length} package options</button>`;
                        }
                    } else {
                        // For measures without packages (like health & safety), show generic incentive text
                        packageDetails = '<em style="color: var(--muted);">May be covered under weatherization or enabling programs</em>';
                    }
                    
                    const coverage = rec.coverage ? `${rec.coverage}%` : 'N/A';
                    const netCost = rec.netCost !== undefined ? `$${rec.netCost.toLocaleString()}` : rec.estimatedCost;
                    
                    html += `
                        <tr id="measure-row-${idx}">
                            <td style="text-align: center;">
                                <input type="checkbox" class="measure-checkbox" data-idx="${idx}" 
                                       onchange="toggleMeasureSelection(${idx})" 
                                       ${rec.selected ? 'checked' : ''}
                                       style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--brand);">
                            </td>
                            <td style="font-size: 1.5rem; text-align: center;">${rec.priority}</td>
                            <td><strong>${rec.measure}</strong><br><small style="color: var(--muted);">${rec.description}</small></td>
                            <td><strong>${rec.estimatedCost}</strong></td>
                            <td style="color: var(--success); font-size: 0.9rem;">${packageDetails}</td>
                            <td><strong style="color: var(--brand);">${coverage}</strong></td>
                            <td><strong style="font-size: 1.1rem;">${netCost}</strong></td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
                
                // Add note for weatherization-eligible customers
                if (eligibilityTier === 'weatherization') {
                    html += `
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">🎉 No-Cost Weatherization Available</h4>
                            <p style="margin-bottom: 0.5rem;">You qualify for Oregon's no-cost weatherization program (OHCS). The incentive packages shown above demonstrate the value of upgrades through alternative programs (CPF, HEAR, HOMES) in case weatherization has a waitlist or you prefer faster alternatives.</p>
                            <p style="margin: 0; font-weight: 600;">All measures shown could be covered at $0 cost through weatherization. Contact 1-800-766-6861 to apply.</p>
                        </div>
                    `;
                }
                
                html += `
                    <div id="costSummary" style="margin-top: 2rem;">
                        ${generateCostSummary(recommendations)}
                    </div>
                `;
                
                // Add program benefits rollup
                html += `
                    <div id="programRollup" style="margin-top: 2rem;">
                        ${generateProgramRollup(recommendations)}
                    </div>
                `;
            }
            
            // Next steps
            html += generateNextStepsSection(eligibility);
            
            // Priority concerns
            if (customer.prioritizedConcerns && customer.prioritizedConcerns.length > 0) {
                html += generatePriorityConcernsSection(customer.prioritizedConcerns);
            }
            
            document.getElementById('comprehensiveResults').innerHTML = html;
        }
        
        function toggleMeasureSelection(idx) {
            if (appState.enrichedRecommendations && appState.enrichedRecommendations[idx]) {
                appState.enrichedRecommendations[idx].selected = !appState.enrichedRecommendations[idx].selected;
                updateCostSummary();
            }
        }
        
        function updateCostSummary() {
            const summaryDiv = document.getElementById('costSummary');
            const rollupDiv = document.getElementById('programRollup');
            
            if (summaryDiv && appState.enrichedRecommendations) {
                summaryDiv.innerHTML = generateCostSummary(appState.enrichedRecommendations);
            }
            
            if (rollupDiv && appState.enrichedRecommendations) {
                rollupDiv.innerHTML = generateProgramRollup(appState.enrichedRecommendations);
            }
        }
        
        /**
         * Toggle HOMES opt-out and recalculate incentives dynamically
         */
        function toggleHOMESOptOut() {
            const optOutChecked = document.getElementById('optOutHOMES').checked;
            console.log('HOMES opt-out toggled:', optOutChecked);
            
            if (!appState.enrichedRecommendations || typeof IncentiveRules === 'undefined') {
                console.error('Cannot toggle HOMES: missing data or IncentiveRules');
                return;
            }
            
            const incentiveRules = new IncentiveRules();
            
            // Remove or restore HOMES incentives for each measure
            appState.enrichedRecommendations.forEach(rec => {
                if (!rec.bestPackage || !rec.bestPackage.incentives) return;
                
                if (optOutChecked) {
                    // Remove HOMES incentives
                    rec.bestPackage.incentives = rec.bestPackage.incentives.filter(inc => 
                        !inc.program || !inc.program.includes('HOMES')
                    );
                    console.log(`Removed HOMES from ${rec.measure}`);
                } else {
                    // Check if HOMES should be added back (only if no HEAR on same measure)
                    const hasHEAR = rec.bestPackage.incentives.some(inc => 
                        inc.program && inc.program.includes('HEAR')
                    );
                    
                    const hasHOMES = rec.bestPackage.incentives.some(inc => 
                        inc.program && inc.program.includes('HOMES')
                    );
                    
                    // Add HOMES back if eligible and doesn't have HEAR
                    const measureRule = incentiveRules.getMeasureRules()[rec.measureId];
                    if (!hasHEAR && !hasHOMES && measureRule && measureRule.homes_eligible) {
                        rec.bestPackage.incentives.push({
                            program: 'HOMES (IRA Federal)',
                            amount: 0, // Will be allocated in applyHOMESAllocation
                            priority: 1,
                            contact: 'Oregon DOE',
                            note: 'Allocated dynamically up to $10K site cap (fills gaps after other incentives)'
                        });
                        console.log(`Added HOMES back to ${rec.measure}`);
                    }
                }
            });
            
            // Reapply HOMES allocation if not opted out
            if (!optOutChecked) {
                console.log('Reapplying HOMES allocation...');
                incentiveRules.applyHOMESAllocation(appState.enrichedRecommendations, appState.eligibilityTier);
            }
            
            // Recalculate totals for all measures
            console.log('Recalculating totals after HOMES toggle...');
            appState.enrichedRecommendations.forEach(rec => {
                if (rec.bestPackage && rec.bestPackage.incentives) {
                    const costCalc = incentiveRules.calculateNetCost(rec.estimatedCostNum, rec.bestPackage);
                    rec.totalIncentives = costCalc.totalIncentives;
                    rec.netCost = costCalc.netCost;
                    rec.coverage = costCalc.coverage;
                    console.log(`  ${rec.measure}: Incentives=$${rec.totalIncentives.toLocaleString()}, Net=$${rec.netCost.toLocaleString()}, Coverage=${rec.coverage}%`);
                }
            });
            
            // Update the display
            console.log('Updating table and summaries...');
            updateRecommendationsTable();
            updateCostSummary();
            console.log('HOMES toggle complete');
        }
        
        /**
         * Apply or remove no-cost enhancement
         * @param {boolean} applyEnhancement - Whether to apply or remove enhancement
         */
        function applyNoCostEnhancement(applyEnhancement) {
            console.log('applyNoCostEnhancement called:', applyEnhancement);
            
            if (!appState.enrichedRecommendations || typeof IncentiveRules === 'undefined') {
                console.error('Cannot apply No-Cost: missing data or IncentiveRules');
                return;
            }
            
            const incentiveRules = new IncentiveRules();
            const optOutHOMESEl = document.getElementById('optOutHOMES');
            const optOutHOMES = optOutHOMESEl ? optOutHOMESEl.checked : false;
            
            // Eligible measure types for no-cost treatment
            const noCostMeasures = [
                'attic_insulation',
                'wall_insulation',
                'floor_insulation',
                'heat_pump_ducted',
                'heat_pump_ductless',
                'heat_pump_water_heater'
            ];
            
            appState.enrichedRecommendations.forEach(rec => {
                if (!rec.bestPackage || !rec.bestPackage.incentives) return;
                if (!noCostMeasures.includes(rec.measureId)) return;
                
                // Find CPF incentive
                const cpfIncentive = rec.bestPackage.incentives.find(inc => 
                    inc.program && inc.program.includes('CPF')
                );
                
                if (cpfIncentive) {
                    if (applyEnhancement) {
                        // Apply enhanced no-cost CPF - increase to cover full cost minus other incentives
                        const otherIncentives = rec.bestPackage.incentives
                            .filter(inc => !inc.program.includes('CPF'))
                            .reduce((sum, inc) => sum + (typeof inc.amount === 'number' ? inc.amount : 0), 0);
                        
                        const gap = Math.max(0, rec.estimatedCostNum - otherIncentives);
                        cpfIncentive.amount = Math.ceil(gap * 1.1); // 10% buffer for no-cost assurance
                        cpfIncentive.note = 'Enhanced CPF no-cost coverage (may exceed remaining cost for assurance)';
                        console.log(`Enhanced CPF for ${rec.measure}: $${cpfIncentive.amount.toLocaleString()}`);
                    } else {
                        // Revert to standard CPF amounts
                        const measureRule = incentiveRules.getMeasureRules()[rec.measureId];
                        if (measureRule) {
                            const measureDetails = {
                                housingType: appState.customerData.housingType,
                                sqft: rec.sqft || parseInt(appState.assessmentData.homeSquareFootage) || 2000
                            };
                            const standardCPF = incentiveRules.getCPFAmount(rec.measureId, measureDetails);
                            if (standardCPF && typeof standardCPF === 'number') {
                                cpfIncentive.amount = standardCPF;
                                cpfIncentive.note = 'Standard CPF incentive';
                                console.log(`Standard CPF for ${rec.measure}: $${cpfIncentive.amount.toLocaleString()}`);
                            }
                        }
                    }
                }
            });
            
            // Reapply HOMES allocation if not opted out
            if (!optOutHOMES) {
                console.log('Reapplying HOMES allocation after No-Cost toggle...');
                incentiveRules.applyHOMESAllocation(appState.enrichedRecommendations, appState.eligibilityTier);
            }
            
            // Recalculate totals for all measures
            console.log('Recalculating totals after No-Cost toggle...');
            appState.enrichedRecommendations.forEach(rec => {
                if (rec.bestPackage && rec.bestPackage.incentives) {
                    const costCalc = incentiveRules.calculateNetCost(rec.estimatedCostNum, rec.bestPackage);
                    rec.totalIncentives = costCalc.totalIncentives;
                    rec.netCost = costCalc.netCost;
                    rec.coverage = costCalc.coverage;
                    console.log(`  ${rec.measure}: Incentives=$${rec.totalIncentives.toLocaleString()}, Net=$${rec.netCost.toLocaleString()}, Coverage=${rec.coverage}%`);
                }
            });
            
            // Update the display
            console.log('Updating table and summaries...');
            updateRecommendationsTable();
            updateCostSummary();
            console.log('No-Cost enhancement complete');
        }
        
        /**
         * Toggle No-Cost Eligible checkbox and apply changes
         */
        function toggleNoCostEligible() {
            const noCostChecked = document.getElementById('noCostEligible').checked;
            console.log('No-Cost Eligible toggled:', noCostChecked);
            applyNoCostEnhancement(noCostChecked);
        }
        
        /**
         * Update the recommendations table with new incentive values
         */
        function updateRecommendationsTable() {
            if (!appState.enrichedRecommendations) {
                console.error('updateRecommendationsTable: No enrichedRecommendations');
                return;
            }
            
            console.log('Updating recommendations table...');
            appState.enrichedRecommendations.forEach((rec, idx) => {
                const row = document.getElementById(`measure-row-${idx}`);
                if (!row) {
                    console.warn(`Row not found for measure ${idx}: ${rec.measure}`);
                    return;
                }
                
                // Update package details cell
                let packageDetails = '';
                if (rec.bestPackage && rec.bestPackage.incentives) {
                    packageDetails = `<strong>${rec.bestPackage.name}</strong><br>`;
                    packageDetails += rec.bestPackage.incentives
                        .filter(inc => typeof inc.amount === 'number' && inc.amount > 0) // Only show non-zero amounts
                        .map(inc => {
                            const amount = `$${inc.amount.toLocaleString()}`;
                            return `<div style="margin: 0.25rem 0; font-size: 0.85rem;">${inc.program}: ${amount}</div>`;
                        }).join('');
                    
                    if (rec.bestPackage.note) {
                        packageDetails += `<div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--muted); font-style: italic;">${rec.bestPackage.note}</div>`;
                    }
                } else {
                    packageDetails = '<em style="color: var(--muted);">May be covered under weatherization or enabling programs</em>';
                }
                
                // Update cells
                const cells = row.querySelectorAll('td');
                if (cells.length >= 7) {
                    cells[4].innerHTML = `<span style="color: var(--success); font-size: 0.9rem;">${packageDetails}</span>`;
                    cells[5].innerHTML = `<strong style="color: var(--brand);">${rec.coverage ? rec.coverage + '%' : 'N/A'}</strong>`;
                    cells[6].innerHTML = `<strong style="font-size: 1.1rem;">$${rec.netCost.toLocaleString()}</strong>`;
                }
            });
        }
        
        /**
         * Calculate monthly loan payments for 0% and 15% APR over 5-year term
         * @param {number} principal - Loan amount (net cost after incentives)
         * @returns {object} Object with formatted monthly payment strings
         */
        function calculateFinancing(principal) {
            if (principal <= 0) {
                return { zeroPercent: '$0', fifteenPercent: '$0' };
            }
            
            const months = 60; // 5-year term
            
            // 0% APR - Simple division
            const zeroPercentPayment = principal / months;
            
            // 15% APR - Use standard loan payment formula: P * [r(1+r)^n] / [(1+r)^n - 1]
            const annualRate = 0.15;
            const monthlyRate = annualRate / 12;
            const fifteenPercentPayment = principal * 
                (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                (Math.pow(1 + monthlyRate, months) - 1);
            
            return {
                zeroPercent: `$${Math.round(zeroPercentPayment).toLocaleString()}`,
                fifteenPercent: `$${Math.round(fifteenPercentPayment).toLocaleString()}`
            };
        }
        
        /**
         * Generate program benefits rollup showing which programs contribute to which measures
         */
        function generateProgramRollup(recommendations) {
            // Aggregate incentives by program across all selected measures
            const programTotals = {};
            const programMeasures = {};
            
            recommendations.filter(r => r.selected && r.bestPackage).forEach(rec => {
                if (rec.bestPackage && rec.bestPackage.incentives) {
                    rec.bestPackage.incentives.forEach(inc => {
                        const programName = inc.program;
                        const amount = typeof inc.amount === 'number' ? inc.amount : 0;
                        
                        if (!programTotals[programName]) {
                            programTotals[programName] = 0;
                            programMeasures[programName] = [];
                        }
                        
                        programTotals[programName] += amount;
                        programMeasures[programName].push({
                            name: rec.measure,
                            amount: amount
                        });
                    });
                }
            });
            
            // Sort programs by total amount (highest first)
            const sortedPrograms = Object.entries(programTotals)
                .sort((a, b) => b[1] - a[1]);
            
            if (sortedPrograms.length === 0) {
                return '';
            }
            
            let html = `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">💰 Program Benefits Breakdown</h3>
                <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.5rem; border-radius: 12px; border: 2px solid #dee2e6;">
                    <p style="margin-bottom: 1rem; color: var(--muted);">Your selected measures are funded by the following programs:</p>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--brand); color: white;">
                                <th style="padding: 0.75rem; text-align: left; border-radius: 8px 0 0 0;">Program</th>
                                <th style="padding: 0.75rem; text-align: right;">Total Incentive</th>
                                <th style="padding: 0.75rem; text-align: left; border-radius: 0 8px 0 0;">Applied To</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedPrograms.forEach(([program, total], idx) => {
                const measures = programMeasures[program];
                const bgColor = idx % 2 === 0 ? 'white' : '#f9fafb';
                const measureList = measures.map(m => {
                    const amt = m.amount > 0 ? ` ($${m.amount.toLocaleString()})` : '';
                    return `${m.name}${amt}`;
                }).join(', ');
                
                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 1rem; font-weight: 600; color: var(--brand);">${program}</td>
                        <td style="padding: 1rem; text-align: right; font-size: 1.1rem; font-weight: bold; color: var(--success);">
                            $${total.toLocaleString()}
                        </td>
                        <td style="padding: 1rem; color: var(--muted); font-size: 0.9rem;">${measureList}</td>
                    </tr>
                `;
            });
            
            // Add total row
            const grandTotal = sortedPrograms.reduce((sum, [_, total]) => sum + total, 0);
            html += `
                        <tr style="background: linear-gradient(135deg, #d4edda, #c3e6cb); font-weight: bold; border-top: 3px solid var(--brand);">
                            <td style="padding: 1rem; font-size: 1.1rem;">TOTAL INCENTIVES</td>
                            <td style="padding: 1rem; text-align: right; font-size: 1.3rem; color: var(--brand);">$${grandTotal.toLocaleString()}</td>
                            <td style="padding: 1rem; color: var(--muted); font-size: 0.9rem;">${sortedPrograms.length} program(s)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            `;
            
            return html;
        }
        
        function generateCostSummary(recommendations) {
            const selected = recommendations.filter(r => r.selected);
            const all = recommendations;
            
            // Calculate selected totals
            let selectedCost = 0;
            let selectedIncentives = 0;
            let selectedMonthlySavings = 0;
            selected.forEach(r => {
                selectedCost += r.estimatedCostNum || 0;
                selectedIncentives += r.totalIncentives || 0;
                selectedMonthlySavings += r.monthlySavings || 0;
            });
            const selectedNet = selectedCost - selectedIncentives;
            const selectedAnnualSavings = selectedMonthlySavings * 12;
            
            // Calculate full scope totals
            let fullCost = 0;
            let fullIncentives = 0;
            let fullMonthlySavings = 0;
            all.forEach(r => {
                fullCost += r.estimatedCostNum || 0;
                fullIncentives += r.totalIncentives || 0;
                fullMonthlySavings += r.monthlySavings || 0;
            });
            const fullNet = fullCost - fullIncentives;
            const fullAnnualSavings = fullMonthlySavings * 12;
            
            // Calculate financing options for net costs
            const selectedFinancing = calculateFinancing(selectedNet);
            const fullFinancing = calculateFinancing(fullNet);
            
            return `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Cost Summary</h3>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--success);">
                        <h4 style="color: var(--brand); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ✅ Selected Measures (${selected.length})
                        </h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600;">Total Cost:</span>
                                <span style="font-size: 1.1rem; font-weight: bold;">$${selectedCost.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600; color: var(--success);">Total Incentives:</span>
                                <span style="font-size: 1.1rem; font-weight: bold; color: var(--success);">-$${selectedIncentives.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--brand); color: white; border-radius: 8px; margin-top: 0.5rem;">
                                <span style="font-weight: bold; font-size: 1.1rem;">Your Net Cost:</span>
                                <span style="font-size: 1.3rem; font-weight: bold;">$${selectedNet.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
                                ${Math.round((selectedIncentives / selectedCost) * 100) || 0}% covered by incentives
                            </div>
                            ${selectedMonthlySavings > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h5 style="margin: 0 0 0.75rem 0; color: var(--brand); font-size: 0.95rem;">💵 Estimated Energy Savings</h5>
                                    <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Monthly Savings:</span>
                                            <strong style="color: var(--success);">≈$${selectedMonthlySavings}/month</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Annual Savings:</span>
                                            <strong style="color: var(--success);">≈$${selectedAnnualSavings.toLocaleString()}/year</strong>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedNet > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h5 style="margin: 0 0 0.75rem 0; color: var(--brand); font-size: 0.95rem;">💳 Financing Options (5-year term)</h5>
                                    <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>0% APR:</span>
                                            <strong style="color: var(--success);">${selectedFinancing.zeroPercent}/month</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>15% APR:</span>
                                            <strong>${selectedFinancing.fifteenPercent}/month</strong>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--accent);">
                        <h4 style="color: var(--accent-dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📊 Full Scope (${all.length} measures)
                        </h4>
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600;">Total Cost:</span>
                                <span style="font-size: 1.1rem; font-weight: bold;">$${fullCost.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border-radius: 8px;">
                                <span style="font-weight: 600; color: var(--success);">Total Incentives:</span>
                                <span style="font-size: 1.1rem; font-weight: bold; color: var(--success);">-$${fullIncentives.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: var(--accent); color: white; border-radius: 8px; margin-top: 0.5rem;">
                                <span style="font-weight: bold; font-size: 1.1rem;">Your Net Cost:</span>
                                <span style="font-size: 1.3rem; font-weight: bold;">$${fullNet.toLocaleString()}</span>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
                                ${Math.round((fullIncentives / fullCost) * 100) || 0}% covered by incentives
                            </div>
                            ${fullMonthlySavings > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h5 style="margin: 0 0 0.75rem 0; color: var(--accent-dark); font-size: 0.95rem;">💵 Estimated Energy Savings</h5>
                                    <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Monthly Savings:</span>
                                            <strong style="color: var(--success);">≈$${fullMonthlySavings}/month</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Annual Savings:</span>
                                            <strong style="color: var(--success);">≈$${fullAnnualSavings.toLocaleString()}/year</strong>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            ${fullNet > 0 ? `
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <h5 style="margin: 0 0 0.75rem 0; color: var(--accent-dark); font-size: 0.95rem;">💳 Financing Options (5-year term)</h5>
                                    <div style="display: grid; gap: 0.5rem; font-size: 0.85rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>0% APR:</span>
                                            <strong style="color: var(--success);">${fullFinancing.zeroPercent}/month</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>15% APR:</span>
                                            <strong>${fullFinancing.fifteenPercent}/month</strong>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function showPackageOptions(idx) {
            const rec = appState.enrichedRecommendations[idx];
            if (!rec || !rec.packages) return;
            
            let html = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <h3 style="color: var(--brand); margin-bottom: 1rem;">${rec.measure} - Package Options</h3>
                        <p style="color: var(--muted); margin-bottom: 1.5rem;">Choose the best incentive package for your situation:</p>
            `;
            
            rec.packages.forEach((pkg, pkgIdx) => {
                const costCalc = new IncentiveRules().calculateNetCost(rec.estimatedCostNum, pkg);
                const isBest = pkg === rec.bestPackage;
                
                html += `
                    <div style="background: ${isBest ? 'linear-gradient(135deg, #d4edda, #c3e6cb)' : '#f9fafb'}; border: 2px solid ${isBest ? 'var(--success)' : '#e5e7eb'}; border-radius: 10px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: var(--brand); margin: 0;">${pkg.name} ${isBest ? '⭐ RECOMMENDED' : ''}</h4>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: var(--muted);">Net Cost</div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: var(--brand);">$${costCalc.netCost.toLocaleString()}</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                `;
                
                pkg.incentives.forEach(inc => {
                    const amount = typeof inc.amount === 'number' ? `$${inc.amount.toLocaleString()}` : inc.amount;
                    html += `
                        <div style="padding: 0.5rem; background: white; border-radius: 5px; margin: 0.5rem 0;">
                            <strong>${inc.program}:</strong> ${amount}
                            ${inc.note ? `<br><small style="color: var(--muted);">${inc.note}</small>` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        ${pkg.note ? `<div style="color: var(--muted); font-style: italic; font-size: 0.9rem;">💡 ${pkg.note}</div>` : ''}
                    </div>
                `;
            });
            
            html += `
                        <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="padding: 0.75rem 2rem; background: var(--brand); color: white; border: none; border-radius: 999px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 1rem;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function generateNextStepsSection(eligibility) {
            let html = `
                <h3 style="color: var(--brand); margin: 2rem 0 1rem;">Next Steps & Resources</h3>
                <div class="form-grid">
            `;
            
            if (eligibility.weatherization) {
                html += `
                    <div class="info-panel">
                        <h4>🎉 Oregon Weatherization (PRIORITY)</h4>
                        <p><strong>Phone:</strong> 1-800-766-6861<br>
                        <strong>Website:</strong> oregon.gov/ohcs/energy-weatherization<br>
                        <strong>Action:</strong> Apply immediately for no-cost comprehensive upgrades</p>
                    </div>
                `;
            }
            
            if (eligibility.cpfEligible) {
                html += `
                    <div class="info-panel">
                        <h4>⭐ Community Partner Fund (CPF)</h4>
                        <p><strong>Contact:</strong> Energy Trust Community Partner<br>
                        <strong>Website:</strong> energytrust.org/cpf<br>
                        <strong>Action:</strong> Work with your CBO or find a partner to access enhanced rebates</p>
                    </div>
                `;
            }
            
            html += `
                <div class="info-panel">
                    <h4>⚡ Energy Trust of Oregon</h4>
                    <p><strong>Phone:</strong> 1-866-368-7878<br>
                    <strong>Website:</strong> energytrust.org<br>
                    <strong>Action:</strong> Find Trade Ally contractors at energytrust.org/find-a-contractor</p>
                </div>
            `;
            
            if (eligibility.hearLowIncome || eligibility.hearModerate) {
                html += `
                    <div class="info-panel">
                        <h4>🇺🇸 HEAR Federal Program (IRA)</h4>
                        <p><strong>Phone:</strong> Oregon DOE 1-800-221-8035<br>
                        <strong>Website:</strong> oregon.gov/energy/incentives<br>
                        <strong>Action:</strong> Check availability - program launching in phases</p>
                    </div>
                `;
            }
            
            if (eligibility.liheap) {
                html += `
                    <div class="info-panel">
                        <h4>💵 LIHEAP Bill Assistance</h4>
                        <p><strong>Contact:</strong> Local Community Action Agency<br>
                        <strong>Action:</strong> Get help with energy bills while planning upgrades</p>
                    </div>
                `;
            }
            
            html += `
                </div>
            `;
            
            return html;
        }
        
        function generatePriorityConcernsSection(concerns) {
            let html = `
                <div class="alert alert-info" style="margin-top: 2rem;">
                    <h4 style="margin-bottom: 0.5rem;">🎯 Your Priority Concerns (Ranked)</h4>
                    <div style="margin-top: 1rem;">
            `;
            
            concerns.forEach((concern, idx) => {
                html += `
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin: 0.5rem 0; padding: 0.5rem; background: white; border-radius: 8px; border-left: 4px solid var(--brand);">
                        <span style="background: var(--brand); color: white; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">#${idx + 1}</span>
                        <span style="font-size: 1.2rem;">${concern.icon}</span>
                        <span style="flex: 1; font-weight: 600;">${concern.text}</span>
                        <span style="color: var(--muted); font-size: 0.85rem;">Weight: ${concern.weight}</span>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <p style="margin-top: 1rem; font-size: 0.9rem;"><strong>Note:</strong> Our recommendations are prioritized to address your top concerns first.</p>
                </div>
            `;
            
            return html;
        }
        
        // Note: Removed showBasicResults - we only use enriched results with proper incentive calculations

        // Override the button to call comprehensive results
        function proceedToResults() {
            goToStep(4);
            if (appState.recommendations.length > 0) {
                showComprehensiveResults();
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function downloadReport() {
            // Use the comprehensive generated report if available, otherwise fallback
            let fullReport = appState.lastGeneratedReport;
            
            if (!fullReport) {
                let reportContent = document.getElementById('comprehensiveResults').innerHTML;
                
                // Disable all checkboxes in the downloaded report
                reportContent = reportContent.replace(/<input([^>]*type=["']checkbox["'][^>]*)>/gi, '<input$1 disabled>');
                // Remove onclick handlers
                reportContent = reportContent.replace(/onchange=["'][^"']*["']/gi, '');
                
                fullReport = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Energy Assessment Report - ${appState.customerData.customerId}</title>
                        <style>
                            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #2c5530; color: white; }
                            .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
                            .alert-success { background-color: #d4edda; border-left: 4px solid #28a745; }
                            .alert-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
                            /* Disable checkbox interaction in static report */
                            input[type="checkbox"] { pointer-events: none; }
                        </style>
                    </head>
                    <body>
                        <h1>Oregon Comprehensive Energy Assessment Report</h1>
                        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        <p style="background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107;">
                            <strong>Note:</strong> This is a static report. Checkboxes are locked to reflect your selections at the time of download.
                        </p>
                        ${reportContent}
                    </body>
                    </html>
                `;
            }
            
            const blob = new Blob([fullReport], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `energy-assessment-${appState.customerData.customerId}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startOver() {
            if (confirm('Are you sure you want to start a new assessment? Current data will be lost.')) {
                location.reload();
            }
        }
        
        // ===== DRAG AND DROP PRIORITY RANKING =====
        let draggedElement = null;
        
        function initializeDragAndDrop() {
            const pool = document.getElementById('concernsPool');
            const ranking = document.getElementById('priorityRanking');
            
            // Set up drag events for all concern cards
            document.querySelectorAll('.concern-card').forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            // Set up drop zones
            [pool, ranking].forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });
            
            // Allow dropping on cards too for reordering
            document.querySelectorAll('.concern-card').forEach(card => {
                card.addEventListener('dragover', handleDragOverCard);
                card.addEventListener('drop', handleDropOnCard);
            });
        }
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragOverCard(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            if (draggedElement && e.target.classList.contains('concerns-list')) {
                e.target.appendChild(draggedElement);
                updatePriorityRanks();
            }
            
            return false;
        }
        
        function handleDropOnCard(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            
            this.classList.remove('drag-over');
            
            if (draggedElement && this !== draggedElement) {
                const parent = this.parentNode;
                const allCards = [...parent.children].filter(el => el.classList.contains('concern-card'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const targetIndex = allCards.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
                
                updatePriorityRanks();
            }
            
            return false;
        }
        
        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }
        
        function updatePriorityRanks() {
            const ranking = document.getElementById('priorityRanking');
            const cards = ranking.querySelectorAll('.concern-card');
            
            cards.forEach((card, index) => {
                card.setAttribute('data-rank', `#${index + 1}`);
            });
        }
        
        function getPrioritizedConcerns() {
            const ranking = document.getElementById('priorityRanking');
            const cards = ranking.querySelectorAll('.concern-card');
            
            return Array.from(cards).map((card, index) => ({
                id: card.getAttribute('data-id'),
                icon: card.getAttribute('data-icon'),
                text: card.querySelector('.concern-text').textContent,
                rank: index + 1,
                weight: 7 - index // Top item gets 7, descending
            }));
        }
        
        // ===== DEMO DATA LOADER =====
        function loadDemoData(silent = false) {
            try {
                // Customer Info
                document.getElementById('firstName').value = 'Jane';
                document.getElementById('lastName').value = 'Smith';
                document.getElementById('email').value = 'jane.smith@example.com';
                document.getElementById('phone').value = '503-555-1234';
                
                // County
                document.getElementById('county').value = 'Multnomah County';
                
                // Utilities - Select PGE and NW Natural
                document.querySelectorAll('input[name="utilityElectric"]').forEach(cb => {
                    if (cb.value === 'pge') cb.checked = true;
                });
                document.querySelectorAll('input[name="utilityGas"]').forEach(cb => {
                    if (cb.value === 'nw_natural') cb.checked = true;
                });
                
                // Housing
                document.getElementById('housingType').value = 'single_family';
                document.getElementById('ownershipStatus').value = 'own';
                
                // Priority Community (select low-income and rural)
                document.querySelectorAll('input[name="priorityCommunity"]').forEach(cb => {
                    if (cb.value === 'low_income' || cb.value === 'rural') {
                        cb.checked = true;
                    }
                });
                
                // CBO Partnership
                document.getElementById('workingWithCBO').value = 'yes';
                toggleCBODetails(); // Show the CBO name field
                document.getElementById('cboName').value = 'Community Energy Project';
                
                // Priorities - Move top 3 concerns to ranking
                const concernsToRank = ['high_bills', 'comfort', 'old_equipment'];
                const pool = document.getElementById('concernsPool');
                const ranking = document.getElementById('priorityRanking');
                
                if (pool && ranking) {
                    concernsToRank.forEach(concernId => {
                        const card = pool.querySelector(`[data-id="${concernId}"]`);
                        if (card) {
                            ranking.appendChild(card);
                        }
                    });
                    updatePriorityRanks();
                }
                
                // Urgency
                document.getElementById('urgency').value = 'high';
                
                if (!silent) {
                    alert('✅ Demo data loaded! Review the form and click "Continue" to proceed.');
                }
            } catch (error) {
                console.error('Error loading demo data:', error);
                alert('⚠️ Error loading demo data: ' + error.message);
            }
        }
        
        // ===== DEMO DATA - INCOME MODULE =====
        function loadDemoIncomeData(silent = false) {
            try{
                // Household size
                document.getElementById('householdSize').value = '4';
                
                // Income - $55,000 annual (65% AMI for Multnomah County family of 4)
                document.getElementById('income').value = '55000';
                
                // Frequency
                document.getElementById('frequency').value = 'annual';
                
                // Tax status - pre-tax (gross)
                document.querySelector('input[name="taxStatus"][value="pretax"]').checked = true;
                
                if (!silent) {
                    alert('✅ Demo income data loaded! This represents a family of 4 at ~65% AMI in Multnomah County. Click "Calculate Eligibility" to see results.');
                }
            } catch (error) {
                console.error('Error loading demo income data:', error);
                alert('⚠️ Error loading demo income data: ' + error.message);
            }
        }
        
        // ===== DEMO DATA - ASSESSMENT MODULE =====
        function loadDemoAssessmentData(silent = false) {
            try {
                // Property Details
                document.getElementById('homeSquareFootage').value = '2000';
                document.getElementById('conditionedSpace').value = '1800';
                document.getElementById('homeAge').value = '1975';
                document.getElementById('foundationType').value = 'crawlspace';
                document.getElementById('roofCondition').value = 'fair';
                
                // Building Envelope
                document.getElementById('atticInsulation').value = 'poor';
                document.getElementById('wallInsulation').value = 'partial';
                document.getElementById('floorInsulation').value = 'poor';
                document.getElementById('windowType').value = 'single';
                document.getElementById('doorSealing').value = 'poor';
                
                // HVAC Systems
                document.getElementById('heatingType').value = 'gas_furnace';
                document.getElementById('heatingAge').value = '20';
                document.getElementById('coolingType').value = 'none';
                document.getElementById('ductwork').value = 'fair';
                
                // Water Heating
                document.getElementById('waterHeaterType').value = 'gas_tank';
                document.getElementById('waterHeaterAge').value = '15';
                document.getElementById('waterHeaterLocation').value = 'basement';
                
                // Health & Safety - Select a few issues
                document.querySelectorAll('input[name="healthSafety"]').forEach(cb => {
                    if (cb.value === 'combustion' || cb.value === 'moisture') {
                        cb.checked = true;
                    } else {
                        cb.checked = false;
                    }
                });
                
                if (!silent) {
                    alert('✅ Demo assessment data loaded! This represents a 1975 home with poor insulation, old equipment, and some health/safety issues. Click "Analyze Home Assessment" to see recommendations.');
                }
            } catch (error) {
                console.error('Error loading demo assessment data:', error);
                alert('⚠️ Error loading demo assessment data: ' + error.message);
            }
        }
        
        // ===== QUICK DEMO MODE - Load all data and skip to recommendations =====
        let isQuickDemoMode = false; // Global flag to track if we're in quick demo mode
        
        function loadFullDemoAndSkip() {
            try {
                // Show loading message
                const originalText = event.target.innerHTML;
                event.target.innerHTML = '⏳ Loading Demo...';
                event.target.disabled = true;
                isQuickDemoMode = true; // Activate quick demo mode
                
                setTimeout(() => {
                    try {
                        // Step 1: Load customer intake data (silently)
                        loadDemoData(true);
                        
                        // Step 2: Submit intake form programmatically
                        submitIntake();
                        
                        // Wait longer for intake processing to ensure state is ready
                        setTimeout(() => {
                            // Verify customer data is set
                            if (!appState.customerData || !appState.customerData.county) {
                                console.error('Customer data not ready');
                                alert('⚠️ Demo failed: Customer data not initialized');
                                event.target.innerHTML = originalText;
                                event.target.disabled = false;
                                isQuickDemoMode = false;
                                return;
                            }
                            
                            // Step 3: Navigate to income module (will auto-load via demo flag)
                            goToStep(2);
                            
                            setTimeout(() => {
                                // Step 4: Calculate income
                                try {
                                    calculateIncome();
                                } catch (calcError) {
                                    console.error('Income calculation error:', calcError);
                                    alert('⚠️ Demo failed at income calculation: ' + calcError.message);
                                    event.target.innerHTML = originalText;
                                    event.target.disabled = false;
                                    isQuickDemoMode = false;
                                    return;
                                }
                                
                                setTimeout(() => {
                                    // Step 5: Navigate to assessment module (will auto-load via demo flag)
                                    goToStep(3);
                                    
                                    // Wait longer to ensure assessment data loads before analyzing
                                    setTimeout(() => {
                                        // Step 6: Analyze assessment
                                        try {
                                            analyzeAssessment();
                                        } catch (assessError) {
                                            console.error('Assessment error:', assessError);
                                            alert('⚠️ Demo failed at assessment: ' + assessError.message);
                                            event.target.innerHTML = originalText;
                                            event.target.disabled = false;
                                            isQuickDemoMode = false;
                                            return;
                                        }
                                        
                                        // Step 7: Show comprehensive results
                                        setTimeout(() => {
                                            showComprehensiveResults();
                                            
                                            // Reset button and demo mode
                                            event.target.innerHTML = originalText;
                                            event.target.disabled = false;
                                            isQuickDemoMode = false;
                                            
                                            // Scroll to top smoothly
                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                        }, 500);
                                    }, 600);  // Increased delay to ensure demo data loads
                                }, 400);
                            }, 300);
                        }, 300);
                    } catch (innerError) {
                        console.error('Error in demo flow:', innerError);
                        event.target.innerHTML = originalText;
                        event.target.disabled = false;
                        isQuickDemoMode = false;
                        alert('⚠️ Error in quick demo: ' + innerError.message);
                    }
                }, 100);
            } catch (error) {
                console.error('Error loading full demo:', error);
                isQuickDemoMode = false;
                alert('⚠️ Error loading quick demo: ' + error.message);
            }
        }
    </script>
    
    <!-- Copyright Footer -->
    <footer style="background: rgba(255, 255, 255, 0.95); margin-top: 3rem; padding: 2rem; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);">
        <div style="max-width: 900px; margin: 0 auto;">
            <p style="font-size: 0.95rem; color: #2c5530; font-weight: 600; margin-bottom: 0.5rem;">
                Oregon Comprehensive Energy Assessment Tool
            </p>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 0.75rem;">
                Copyright © 2025 <strong>Isaiah Kamrar / Community Consulting Partners LLC</strong><br>
                All Rights Reserved. Proprietary Software.
            </p>
            <p style="font-size: 0.85rem; color: #888; line-height: 1.6;">
                This tool is provided for informational purposes only and does not guarantee program eligibility or incentive amounts.<br>
                For official program information, contact program administrators directly.
            </p>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <p style="font-size: 0.8rem; color: #999;">
                    <strong>Licensing:</strong> Non-profit & government agencies may use freely with attribution. Commercial use requires paid license.<br>
                    Contact: <a href="mailto:dikamrar@gmail.com" style="color: #2c5530;">dikamrar@gmail.com</a> | 
                    <a href="LICENSE.md" style="color: #2c5530;">View License Terms</a>
                </p>
            </div>
        </div>
    </footer>
    
    <!-- Initialize classes for browser -->
    <script>
        // Ensure classes are available globally
        if (typeof window !== 'undefined') {
            console.log('Checking class availability...');
            console.log('ConfigLoader:', typeof ConfigLoader);
            console.log('IncentiveRules:', typeof IncentiveRules);
            
            if (typeof ConfigLoader === 'undefined') {
                console.error('❌ ConfigLoader not loaded');
            }
            if (typeof IncentiveRules === 'undefined') {
                console.error('❌ IncentiveRules not loaded');
            }
            
            if (typeof ConfigLoader !== 'undefined' && typeof IncentiveRules !== 'undefined') {
                console.log('✅ All classes loaded successfully');
            }
        }
    </script>
</body>
</html>
